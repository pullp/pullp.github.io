---
layout:     post
title:      ssh 常用操作
subtitle:   ssh, autossh
date:       2020-09-13
author:     wxk1997
header-img: img/default-bg.png
catalog: true
tags:
    - ssh
---

# 1. 前言

最近新装了一台ubuntu, 照例又是配置各种环境. 在配置ssh的时候遇到很多操作都不记得具体步骤, 又得从网上查怎么操作. 因此觉得有必要记录一下ssh的一些常用操作, 方便下次再配置ssh时进行查阅.

# 2. 正文

## 2.1. 生成密钥对

```
ssh-keygen
```

私钥路径: `~/.ssh/id_rsa`
公钥路径: `~/.ssh/id_rsa.pub`

## 2.2. 添加公钥

```bash
cat ./id_rsa.pub >> ~/.ssh/authorized_keys
```

## 2.3. 禁用密码登录

```bash
vim /etc/ssh/sshd_config

PasswordAuthentication no
```

## 2.4. 端口转发功能

### 2.4.1. ssh -L

设有三台主机: `A`, `B`, `C`. 其对应ip为 `ip_A`, `ip_B`, `ip_C`.

如果在主机`A`上执行:

```bash
ssh -L 1234:ip_C:5678 root@ip_B
```

那么访问主机`A`的`1234`端口就等价于访问主机 `C` 的 `5678` 端口

这种转发方式的应用场景为: `A`可以访问`B`, `B`可以访问`C`, 但是`A`不能直接访问`C`.

### 2.4.2. ssh -R

设有两台主机: `A`, `B`. 其对应ip为 `ip_A`, `ip_B`.

如果在主机`A`上执行:

```bash
ssh -R 1234:127.0.0.1:5678 root@ip_B
```

***注意: 这儿一定要是root用户***

那么此时在`B`上访问 `localhost:1234` 就等价于访问 `A` 的 `5678` 端口.

***若想实现可以通过`ip_B:1234`访问`ip_A:5678`还需要配置一层代理, 具体方式后面关于内网穿透的章节会说***

这种转发方式的应用场景为: `A`是一个内网主机, `B` 是一个公网主机. 用户想随时随地可以访问`A`, 就需要做一个反向代理实现内网穿透, 使得用户可以通过 `B` 作为中介访问 `A`.

### 2.4.3. ssh -D

设有两台主机: `A`, `B`. 其对应ip为 `ip_A`, `ip_B`.

如果在主机`A`上执行:

```bash
ssh -D 1234 root@ip_B
```

那么主机`A`的 `localhost:1234` 就会有一个`socks`代理, 所有走这个代理的流量都会通过主机`B`转发出去.

这种转发方式的应用场景为: 懒得安装/启动socks代理软件客户端.

## 2.5. autossh + xinetd 实现内网穿透

设有两台主机: `A`, `B`. 其对应ip为 `ip_A`, `ip_B`, `A`是一个内网主机, `B` 是一个公网主机. 我们的需求是随时随地可以访问`A`上的资源.

我们可以使用前面提到的 `ssh -R` 转发方式, 在`A`上执行:

```
ssh -R 1234:127.0.0.1:22 root@ip_B
```

***注意: 22是ssh server的端口***

此时我们若在`B`上执行

```
ssh root@127.0.0.1 -p 1234
```

并输入`A`上`root`用户的密码, 我们就可以成功登录主机`A`.

但是`B`的`127.0.0.1`只有自己能访问, 别的主机想访问`B`上的`1234`端口只能通过`ip_B`进行访问, 所以我们这儿可以在`B`上启动一个转发服务: 将`ip_B:5678`来的流量转发至`127.0.0.1:1234`(***两个端口建议不相同, 避免可能的冲突***). 我这儿用的是 `xinetd`:

```bash
$ sudo apt install xinetd
$ cat ./proxy
service http-switch
{
 disable = no
 type = UNLISTED
 socket_type = stream
 protocol = tcp
 wait = no
 redirect = 127.0.0.1 1234
 bind = 0.0.0.0
 port = 5678
 user = nobody
}
$ cp ./proxy /etc/xinetd.d/
$ sudo /etc/init.d/xinetd restart
[ ok ] Restarting xinetd (via systemctl): xinetd.service.
```

此时我们在任何一台可以访问外网的主机上执行如下命令:

```
ssh root@ip_B -p 5678
```

并输入`A`上`root`用户的密码, 就可以登录上`A`了.

`autossh`和`ssh`功能差不多, 但是多一个自动断线重连功能, 因此搭建内网穿透服务的时候稳定性更好.

使用命令和`ssh`类似:

```
$ sudo apt install autossh
$ autossh -M 7788 -NfR 1234:127.0.0.1:22 root@ip_B
```

`-M` 参数声明一个没有被占用的端口, `autossh` 会使用这个端口检测连接是否存在, 如果断掉的话就需要进行重连操作. 

`-N` 和 `-f` 参数是让 `autossh` 不打印信息, 在后台运行. (`ssh`同样可以加上这两个参数.)

# 3. 结语

> 不会用ssh的网管不是好程序员

# 4. 参考

1. [SSH 反向隧道 内网穿透，AutoSSH自动重连](https://blog.csdn.net/upshi/article/details/78630285)